<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Pi Network Barter Application" />
    <title>Barter-Pi App</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 'Inter' font for modern look */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- React app को इस div में लोड करेगा -->
    <div id="root"></div>

    <!-- React और ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel (JSX को JS में ट्रांसपाइल करने के लिए) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Imports: ये सभी ज़रूरी मॉड्यूल्स को लोड करते हैं -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables को window object पर expose करना ताकि React component इन्हें इस्तेमाल कर सके
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setLogLevel };
    </script>

    <!-- React Component Code (Babel type) -->
    <script type="text/babel">
        const AppContext = React.createContext(null);
        
        // Global variables को एक्सेस करना
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- 1. Firebase Initialization and Authentication Hook ---

        function useFirebaseInit() {
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Configuration is missing.");
                    setLoading(false);
                    setError("Firebase कॉन्फ़िगरेशन उपलब्ध नहीं है।");
                    return;
                }

                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const firestore = window.firebase.getFirestore(app);
                    const authentication = window.firebase.getAuth(app);
                    
                    window.firebase.setLogLevel('debug'); // Debugging के लिए
                    
                    setDb(firestore);
                    setAuth(authentication);

                    const unsubscribe = window.firebase.onAuthStateChanged(authentication, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                            setLoading(false);
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await window.firebase.signInWithCustomToken(authentication, initialAuthToken);
                                } else {
                                    // Anonymously sign in if no token is provided
                                    await window.firebase.signInAnonymously(authentication);
                                }
                            } catch (e) {
                                console.error("Firebase Sign In Error:", e);
                                setError("लॉगिन में त्रुटि हुई।");
                                setUserId(null); 
                                setIsAuthReady(true);
                                setLoading(false);
                            }
                        }
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    setError(`Firebase शुरू करने में त्रुटि: ${e.message}`);
                    setLoading(false);
                }
            }, []);

            return { db, auth, userId, isAuthReady, loading, error };
        }

        // --- 2. Data Fetching Hook ---

        function useBarterListings(db, isAuthReady, userId) {
            const [listings, setListings] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                if (!db || !isAuthReady) {
                    // अगर Auth Ready नहीं है, तो अभी Fetch न करें
                    return;
                }

                setIsLoading(true);

                // Public collection path: /artifacts/{appId}/public/data/barter_listings
                const collectionPath = `artifacts/${appId}/public/data/barter_listings`;
                const listingsRef = window.firebase.collection(db, collectionPath);

                // Real-time listener: onSnapshot
                const unsubscribe = window.firebase.onSnapshot(listingsRef, 
                    (snapshot) => {
                        const loadedListings = [];
                        snapshot.forEach((doc) => {
                            loadedListings.push({ 
                                id: doc.id, 
                                ...doc.data() 
                            });
                        });
                        
                        // Newest first के लिए Sorting
                        loadedListings.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                        setListings(loadedListings);
                        setIsLoading(false);
                        setError(null);
                    }, 
                    (err) => {
                        console.error("Firestore Fetch Error:", err);
                        // Security Rules की समस्या होने पर यह error आता है
                        setError("लिस्टिंग लोड करने में त्रुटि हुई। कृपया Firestore Security Rules जाँचें।");
                        setIsLoading(false);
                    }
                );

                return () => unsubscribe();
            }, [db, isAuthReady, appId, userId]);

            return { listings, isLoading, error };
        }

        // --- 3. Component Definitions ---

        const BarterListingCard = ({ listing }) => {
            const date = listing.timestamp?.toDate ? listing.timestamp.toDate().toLocaleDateString('hi-IN') : 'N/A';
            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 transition duration-300 transform hover:shadow-xl">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">{listing.itemName || "Unnamed Item"}</h3>
                    <p className="text-sm text-gray-500 mb-4 h-12 overflow-hidden">{listing.description || "कोई विवरण नहीं।"}</p>
                    
                    <div className="flex justify-between items-center mt-4 pt-3 border-t border-dashed border-gray-200">
                        <div className="text-lg font-extrabold text-indigo-600">
                            {listing.pricePi ? `${listing.pricePi} Pi` : "विनिमय के लिए"}
                        </div>
                        <span className={`px-3 py-1 text-xs font-medium rounded-full ${listing.status === 'Active' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                            {listing.status || 'Active'}
                        </span>
                    </div>
                    <p className="text-xs text-gray-400 mt-2 flex justify-between">
                        <span>पोस्टर: <span className="font-mono">{listing.posterId ? listing.posterId.substring(0, 8) + '...' : 'Unknown'}</span></span>
                        <span>दिनांक: {date}</span>
                    </p>
                </div>
            );
        };

        const ListingList = () => {
            const { db, isAuthReady, userId } = React.useContext(AppContext);
            const { listings, isLoading, error } = useBarterListings(db, isAuthReady, userId);

            if (!isAuthReady) {
                return <p className="text-center text-lg text-indigo-600 p-8">ऑथेंटिकेशन (Authentication) शुरू हो रहा है...</p>;
            }

            if (error) {
                return (
                    <div className="text-center p-8 bg-red-100 border border-red-400 rounded-lg shadow-md max-w-lg mx-auto mt-12">
                        <p className="text-xl font-semibold text-red-700 mb-2">त्रुटि: डेटा लोड नहीं हो सका!</p>
                        <p className="text-red-600 mb-4">{error}</p>
                        <p className="text-sm text-red-500">
                            **समाधान:** कृपया सुनिश्चित करें कि आपने अपने Firestore कंसोल में **Security Rules** को अपडेट कर दिया है।
                        </p>
                    </div>
                );
            }

            if (isLoading) {
                return (
                    <div className="flex justify-center items-center p-8">
                        <svg className="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span className="text-lg font-medium text-indigo-600">लिस्टिंग लोड हो रही है...</span>
                    </div>
                );
            }


            if (listings.length === 0) {
                return <p className="text-center text-lg text-gray-500 p-8 bg-gray-100 rounded-lg">कोई लिस्टिंग नहीं मिली। अपनी पहली लिस्टिंग पोस्ट करें!</p>;
            }

            return (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {listings.map(listing => (
                        <BarterListingCard key={listing.id} listing={listing} />
                    ))}
                </div>
            );
        };

        const Header = ({ userId }) => (
            <header className="bg-white shadow-md sticky top-0 z-10">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <h1 className="text-3xl font-extrabold text-indigo-600">
                        Barter-<span className="text-yellow-500">Pi</span>
                    </h1>
                    <div className="text-sm text-gray-600 text-right">
                        आपका यूज़र ID: 
                        <span className="font-mono text-xs bg-gray-100 p-1 rounded block mt-1 leading-tight overflow-x-auto whitespace-nowrap">
                            {userId || 'Loading...'}
                        </span>
                    </div>
                </div>
            </header>
        );

        const PostNewListingButton = () => {
            // Dummy button for now - actual functionality will be added next
            return (
                <button
                    className="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg shadow-xl transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-yellow-300"
                    onClick={() => console.log("Post New Listing clicked")}
                >
                    + नई लिस्टिंग पोस्ट करें
                </button>
            );
        }

        const App = () => {
            const { db, auth, userId, isAuthReady, loading, error } = useFirebaseInit();

            if (loading) {
                return (
                    <div className="flex flex-col justify-center items-center h-screen bg-gray-50">
                        <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span className="text-lg font-medium text-indigo-600 mt-4">एप्लिकेशन शुरू हो रहा है...</span>
                        {error && <p className="text-red-500 mt-2 text-sm">शुरुआत में त्रुटि: {error}</p>}
                    </div>
                );
            }

            return (
                <AppContext.Provider value={{ db, auth, userId, isAuthReady }}>
                    <div className="min-h-screen bg-gray-50">
                        <Header userId={userId} />

                        <main className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                            
                            {/* Listing Section */}
                            <section className="mb-12">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">लेटेस्ट बार्टर लिस्टिंग्स</h2>
                                <ListingList />
                            </section>

                            {/* Post New Section */}
                            <section className="p-8 bg-indigo-50 border border-indigo-200 rounded-xl shadow-lg">
                                <h2 className="text-xl font-semibold text-indigo-800 mb-4">एक नई लिस्टिंग पोस्ट करें</h2>
                                <PostNewListingButton />
                                <p className="text-xs text-indigo-500 mt-3">आपका वर्तमान यूज़र ID लिस्टिंग के साथ जोड़ा जाएगा।</p>
                            </section>

                        </main>
                        
                    </div>
                </AppContext.Provider>
            );
        }

        // App को DOM में रेंडर करें
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
