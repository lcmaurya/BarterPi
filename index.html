<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barter-Pi Testnet</title>
    <script src="https://sdk.mine.pi/pi-platform-library.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles for Pi Branding */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .pi-brand { color: #fcc303; }
        .pi-button { background-color: #fcc303; color: #1c2e4a; font-weight: 700; transition: background-color 0.2s; }
        .pi-button:hover { background-color: #e0ac00; }
        /* Modal Visibility */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); display: none; }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <header class="bg-[#1c2e4a] p-4 shadow-lg sticky top-0 z-10">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white tracking-wider">
                    Barter-<span class="pi-brand">Pi</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <span id="authStatus" class="text-sm text-gray-400">Loading...</span>
                    <button id="authButton" class="bg-gray-700 text-white px-3 py-1 rounded-full text-sm hover:bg-gray-600 transition duration-200">
                        Sign In
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 grid lg:grid-cols-[1fr_360px] gap-6 mt-6">

            <section class="bg-white p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">
                    Latest <span class="pi-brand">Barter</span> Listings (‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§µ‡§∏‡•ç‡§§‡•Å‡§è‡§Ç)
                </h2>
                <div class="mb-6 flex space-x-3">
                    <input type="text" id="searchInput" placeholder="Search items or keywords..."
                           class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-pi-brand focus:border-pi-brand transition duration-150">
                    <button id="searchButton" class="pi-button px-4 py-2 rounded-lg shadow-md">Search</button>
                </div>

                <div id="listingsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p id="loadingMessage" class="col-span-full text-center text-gray-500 py-8">
                        Firestore ‡§∏‡•á ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...
                    </p>
                </div>
            </section>

            <aside class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-pi-brand">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        Post a New <span class="pi-brand">Barter</span> (‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å)
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">
                        ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•â‡§ó ‡§á‡§® ‡§π‡•ã‡§®‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ID: <span id="currentUserId" class="font-mono text-xs text-blue-600">...</span>
                    </p>
                    <button id="openCreateModalButton" class="w-full pi-button py-3 rounded-xl text-lg shadow-xl hover:shadow-2xl">
                        + ‡§®‡§à ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-2xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        Pi Wallet & Orders (‡§ë‡§∞‡•ç‡§°‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏)
                    </h3>
                    <p class="text-gray-600 text-sm mb-4">
                        ‡§Ø‡§π ‡§ñ‡§Ç‡§° Pi Wallet SDK ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á‡§ó‡§æ‡•§
                    </p>
                    <button id="openOrdersModalButton" class="w-full bg-gray-200 text-gray-700 py-2 rounded-xl hover:bg-gray-300 transition duration-200">
                        ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç (‡§≠‡•Å‡§ó‡§§‡§æ‡§®)
                    </button>
                </div>
            </aside>

        </main>
    </div>

    <div id="createListingModal" class="modal-overlay fixed inset-0 z-50 justify-center items-center p-4">
        <div class="bg-white w-full max-w-lg p-6 rounded-xl shadow-3xl transform transition-all duration-300">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Create New Listing (‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç)</h2>
            <form id="listingForm" class="space-y-4">
                <div>
                    <label for="listingTitle" class="block text-sm font-medium text-gray-700">Title (‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï)</label>
                    <input type="text" id="listingTitle" required
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pi-brand focus:border-pi-brand">
                </div>
                <div>
                    <label for="listingPrice" class="block text-sm font-medium text-gray-700">Price in Pi (œÄ ‡§Æ‡•á‡§Ç ‡§ï‡•Ä‡§Æ‡§§)</label>
                    <input type="number" id="listingPrice" required min="0.01" step="0.01" value="1.00"
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pi-brand focus:border-pi-brand">
                </div>
                <div>
                    <label for="listingDescription" class="block text-sm font-medium text-gray-700">Description (‡§µ‡§ø‡§µ‡§∞‡§£)</label>
                    <textarea id="listingDescription" rows="3"
                              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-pi-brand focus:border-pi-brand"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="closeCreateModal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel (‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç)</button>
                    <button type="submit" class="pi-button px-4 py-2 rounded-lg shadow-md">Post Listing (‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç)</button>
                </div>
            </form>
            <p id="listingMessage" class="mt-4 text-sm text-green-600 hidden"></p>
        </div>
    </div>

    <div id="ordersModal" class="modal-overlay fixed inset-0 z-50 justify-center items-center p-4">
        <div class="bg-white w-full max-w-3xl p-6 rounded-xl shadow-3xl transform transition-all duration-300">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Your Transaction History (‡§Ü‡§™‡§ï‡•á ‡§≤‡•á‡§®-‡§¶‡•á‡§®)</h2>

            <div id="paymentsContainer" class="max-h-96 overflow-y-auto space-y-3">
                <p class="text-center text-gray-500 py-4" id="noPaymentsMessage">
                    ‡§ï‡•ã‡§à ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§
                </p>
            </div>

            <div class="flex justify-end pt-4">
                <button type="button" id="closeOrdersModal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close (‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç)</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Canvas environment ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•à‡§∞‡§ø‡§è‡§¨‡§≤
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 1. Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, onSnapshot, addDoc, updateDoc, getDocs, serverTimestamp, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Debug Logging ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç
        setLogLevel('debug');

        // 2. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Pi SDK Initialization (Pi.js)
        if (typeof Pi !== 'undefined') {
            Pi.init({ version: "2.0", sandbox: true }); // Sandbox mode for Testnet
        } else {
            console.error("Pi SDK could not be initialized. Is Pi Platform Library included?");
        }


        let currentUser = null; 

        // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç (security rules) ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ Firestore ‡§™‡§• (paths) ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ø‡§§‡§æ
        const PUBLIC_COLLECTION_PATH = (collectionName) => `/artifacts/${appId}/public/data/${collectionName}`;
        const PRIVATE_COLLECTION_PATH = (collectionName) => `/artifacts/${appId}/users/${currentUser?.uid || 'guest'}/${collectionName}`;

        // 3. Authentication Setup (‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ Pi Auth Token ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à)
        onAuthStateChanged(auth, async (user) => {
            const authStatusEl = document.getElementById('authStatus');
            const authButtonEl = document.getElementById('authButton');
            const currentUserIdEl = document.getElementById('currentUserId');

            if (user) {
                currentUser = user;
                authStatusEl.textContent = `‡§≤‡•â‡§ó ‡§á‡§®: ${user.uid.substring(0, 8)}...`;
                currentUserIdEl.textContent = user.uid;
                authButtonEl.textContent = 'Signed In (Pi User)';
                authButtonEl.disabled = true;

                setupRealtimeListeners();
            } else {
                // ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§µ‡§ø‡§´‡§≤ (Sign-in Failed):", error);
                    authStatusEl.textContent = 'Auth Error';
                    authButtonEl.textContent = 'Login Failed';
                }
            }
        });


        // --- REALTIME DATA LISTENERS (Firestore) ---

        function setupRealtimeListeners() {
            // A. Listings Listener (‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§∂‡•ç‡§∞‡•ã‡§§‡§æ) - ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï (Public)
            const listingsRef = collection(db, PUBLIC_COLLECTION_PATH('listings'));
            const qListings = query(listingsRef, limit(200));

            onSnapshot(qListings, (snapshot) => {
                const listings = [];
                snapshot.forEach(doc => {
                    listings.push({ id: doc.id, ...doc.data() });
                });

                listings.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderListings(listings);
            }, (error) => {
                console.error("‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (Error fetching listings):", error);
                document.getElementById('loadingMessage').textContent = '‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§';
            });

            // B. Payments Listener (‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∂‡•ç‡§∞‡•ã‡§§‡§æ) - ‡§®‡§ø‡§ú‡•Ä (Private)
            const paymentsRef = collection(db, PRIVATE_COLLECTION_PATH('payments'));
            const qPayments = query(paymentsRef, limit(100));

            onSnapshot(qPayments, (snapshot) => {
                const payments = [];
                snapshot.forEach(doc => {
                    payments.push({ id: doc.id, ...doc.data() });
                });
                payments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderPayments(payments);
            }, (error) => {
                console.error("‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (Error fetching payments):", error);
            });
        }


        // --- UI Rendering Functions ---

        function renderListings(listings) {
            const container = document.getElementById('listingsContainer');
            container.innerHTML = '';
            if (listings.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">‡§ï‡•ã‡§à ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</p>';
                return;
            }

            listings.forEach(item => {
                const isSold = item.status === 'sold';
                const card = document.createElement('div');
                card.className = `bg-gray-50 p-4 rounded-xl shadow-lg border-l-4 ${isSold ? 'border-red-500' : 'border-blue-500'} transition hover:shadow-xl`;
                card.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2">
                        <span class="text-xl font-semibold text-gray-800 truncate">${item.title}</span>
                        <span class="ml-auto text-sm font-medium px-2 py-1 rounded-full ${isSold ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                            ${isSold ? '‡§¨‡§ø‡§ï ‡§ó‡§Ø‡§æ (SOLD)' : item.status.toUpperCase()}
                        </span>
                    </div>
                    <p class="text-2xl font-bold pi-brand mb-2">
                        ${(item.pricePi || 0).toFixed(2)} œÄ
                    </p>
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">${item.description || '‡§ï‡•ã‡§à ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§'}</p>
                    <div class="text-xs text-gray-400 mb-3">
                        ‡§Æ‡§æ‡§≤‡§ø‡§ï (Owner): ${item.ownerId?.substring(0, 8) || 'Unknown'} | ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ: ${new Date(item.createdAt?.seconds * 1000).toLocaleDateString()}
                    </div>
                    <button data-listing-id="${item.id}" data-price="${item.pricePi}" data-title="${item.title}"
                            class="buy-button w-full pi-button py-2 rounded-lg text-sm ${isSold ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${isSold ? 'disabled' : ''}>
                        ${isSold ? '‡§¨‡§ø‡§ï ‡§ó‡§Ø‡§æ' : 'Pi ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç'}
                    </button>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.buy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const listingId = e.target.getAttribute('data-listing-id');
                    const amount = parseFloat(e.target.getAttribute('data-price'));
                    const title = e.target.getAttribute('data-title');
                    
                    if (currentUser) {
                        initiatePiPayment(listingId, amount, title);
                    } else {
                        showMessage('‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'red');
                    }
                });
            });
        }

        function renderPayments(payments) {
            const container = document.getElementById('paymentsContainer');
            const noPaymentsMessage = document.getElementById('noPaymentsMessage');
            container.innerHTML = '';
            
            if (payments.length === 0) {
                noPaymentsMessage.style.display = 'block';
                return;
            }
            noPaymentsMessage.style.display = 'none';

            payments.forEach(p => {
                const isPaid = p.status === 'paid';
                const item = document.createElement('div');
                item.className = `p-3 rounded-lg flex justify-between items-center ${isPaid ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'} border`;
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">‡§ë‡§∞‡•ç‡§°‡§∞ (Order): ${p.listingTitle || 'N/A'}</p>
                        <p class="text-xs text-gray-600">ID: ${p.id.substring(0, 10)}... | ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó: ${p.listingId?.substring(0, 10) || 'N/A'}</p>
                        <p class="text-xs text-gray-400">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï (Date): ${new Date(p.createdAt?.seconds * 1000).toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold pi-brand">${(p.amount || 0).toFixed(2)} œÄ</p>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${isPaid ? 'bg-green-600 text-white' : 'bg-yellow-600 text-white'}">
                            ${p.status.toUpperCase()}
                        </span>
                    </div>
                `;
                container.appendChild(item);
            });
        }


        // --- MODAL AND FORM HANDLING ---

        const createModal = document.getElementById('createListingModal');
        const ordersModal = document.getElementById('ordersModal');
        const listingForm = document.getElementById('listingForm');

        document.getElementById('openCreateModalButton').addEventListener('click', () => {
            if (currentUser) {
                 createModal.classList.add('active');
            } else {
                showMessage('‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§', 'red');
            }
        });
        document.getElementById('closeCreateModal').addEventListener('click', () => createModal.classList.remove('active'));
        document.getElementById('openOrdersModalButton').addEventListener('click', () => ordersModal.classList.add('active'));
        document.getElementById('closeOrdersModal').addEventListener('click', () => ordersModal.classList.remove('active'));

        // ‡§®‡§à ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó (New Listing) ‡§ï‡•ã Firestore ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
        listingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('listingTitle').value;
            const pricePi = parseFloat(document.getElementById('listingPrice').value);
            const description = document.getElementById('listingDescription').value;

            if (!title || pricePi <= 0) {
                showMessage('‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§î‡§∞ ‡§è‡§ï ‡§µ‡•à‡§ß Pi ‡§ï‡•Ä‡§Æ‡§§ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§', 'red');
                return;
            }
            
            const listingMessageEl = document.getElementById('listingMessage');
            listingMessageEl.textContent = '‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...';
            listingMessageEl.classList.remove('hidden', 'text-red-600');
            listingMessageEl.classList.add('text-green-600');

            try {
                const newListing = {
                    title: title,
                    pricePi: pricePi,
                    description: description,
                    ownerId: currentUser.uid, 
                    status: 'open',
                    createdAt: serverTimestamp(),
                };

                const listingsRef = collection(db, PUBLIC_COLLECTION_PATH('listings'));
                await addDoc(listingsRef, newListing);

                listingForm.reset();
                showMessage('‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à! ‡§Ø‡§π ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡•Ä‡•§', 'green');
                setTimeout(() => createModal.classList.remove('active'), 1500);

            } catch (error) {
                console.error("‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø (Error creating listing):", error);
                showMessage('‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§', 'red');
            }
        });
        
        // --- CUSTOM MESSAGE BOX (alert() ‡§ï‡•Ä ‡§ú‡§ó‡§π) ---
        function showMessage(message, type = 'green') {
            const el = document.getElementById('listingMessage');
            el.textContent = message;
            el.className = `mt-4 text-sm ${type === 'red' ? 'text-red-600' : 'text-green-600'}`;
            el.classList.remove('hidden');
        }

        // --- PI PAYMENT LOGIC (THIS IS WHERE WE INTEGRATE PI SDK) ---
        
        async function initiatePiPayment(listingId, amount, title) {
            if (typeof Pi === 'undefined') {
                showMessage('Pi SDK ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§ Pi ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡•á‡§Ç‡•§', 'red');
                return;
            }

            const newPaymentId = 'pay_' + Math.random().toString(36).slice(2, 10);
            
            // 1. Firestore ‡§Æ‡•á‡§Ç ‡§≤‡§Ç‡§¨‡§ø‡§§ (pending) ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§¨‡§®‡§æ‡§è‡§Ç
            try {
                const paymentsRef = collection(db, PRIVATE_COLLECTION_PATH('payments'));
                await addDoc(paymentsRef, {
                    id: newPaymentId,
                    listingId: listingId,
                    listingTitle: title,
                    amount: amount,
                    payerId: currentUser.uid,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                });
                showMessage(`‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§¨‡§® ‡§ó‡§Ø‡§æ (ID: ${newPaymentId})‡•§ Pi ‡§µ‡•â‡§≤‡•á‡§ü ‡§ñ‡•Å‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à...`, 'green');

            } catch (error) {
                console.error("‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showMessage('‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§', 'red');
                return;
            }
            
            // 2. Pi.inPayment() ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
            try {
                Pi.inPayment({
                    amount: amount,
                    memo: `Barter-Pi purchase of ${title} (Listing ID: ${listingId})`,
                    metadata: {
                        paymentId: newPaymentId,
                        listingId: listingId
                    }
                }, {
                    onReadyForServerApproval: function(paymentId) {
                        // NOTE: Testnet ‡§Æ‡•á‡§Ç, ‡§Ø‡§π ‡§Ü‡§Æ ‡§§‡•å‡§∞ ‡§™‡§∞ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§´‡§æ‡§Ø‡§∞ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
                        console.log(`Payment Ready for Server Approval (Pi ID: ${paymentId})`);
                        // Production ‡§Æ‡•á‡§Ç, ‡§Ü‡§™‡§ï‡•ã ‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§ Testnet/Sandbox ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§Æ client-side success ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§∞‡§π ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
                    },
                    onReadyForServerCompletion: function(paymentId, txid) {
                        // NOTE: ‡§Ø‡§π callback ‡§ï‡•á‡§µ‡§≤ Testnet ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ú‡§¨ ‡§Ü‡§™ Pi.inPayment.complete() ‡§ï‡•ã client-side ‡§∏‡•á ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§
                        // Production ‡§Æ‡•á‡§Ç, Pi Server ‡§Ø‡§π webhook ‡§Ü‡§™‡§ï‡•á backend ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§ó‡§æ‡•§ 
                        console.log(`Payment Ready for Server Completion (Pi ID: ${paymentId}, TXID: ${txid})`);
                        // **‡§Ø‡§π ‡§µ‡§π ‡§ú‡§ó‡§π ‡§π‡•à ‡§ú‡§π‡§æ‡§Å ‡§π‡§Æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•ã ‡§™‡•Ç‡§∞‡§æ ‡§Æ‡§æ‡§®‡§§‡•á ‡§π‡•à‡§Ç!**
                        completePiPayment(newPaymentId, listingId);
                    },
                    onSuccess: function(payment) {
                        console.log("Pi Payment Successful:", payment);
                        showMessage('Pi ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§´‡§≤! ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§', 'green');
                        // onReadyForServerCompletion ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£, ‡§π‡§Æ ‡§á‡§∏ ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§∞‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§
                    },
                    onIncomplete: function(payment) {
                        console.log("Pi Payment Incomplete:", payment);
                        showMessage('‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§Ö‡§™‡•Ç‡§∞‡•ç‡§£: Pi ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§∏‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§π‡•à‡•§', 'red');
                    },
                    onCancel: function(cancelReason) {
                        console.log("Pi Payment Cancelled:", cancelReason);
                        showMessage('‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§', 'red');
                        // ‡§Ø‡§¶‡§ø ‡§∞‡§¶‡•ç‡§¶ ‡§π‡•ã ‡§ú‡§æ‡§§‡§æ ‡§π‡•à, ‡§§‡•ã Firestore ‡§∏‡•á 'pending' ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç ‡§Ø‡§æ 'cancelled' ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç‡•§
                    },
                    onError: function(error, payment) {
                        console.error("Pi Payment Error:", error, payment);
                        showMessage(`‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message || 'unknown error'}`, 'red');
                    }
                });

            } catch (error) {
                console.error("Pi.inPayment ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showMessage('‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡§Æ‡§∞‡•ç‡§•‡•§ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ Pi ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§π‡•à‡§Ç‡•§', 'red');
            }
        }

        // ‡§∏‡§´‡§≤ Pi ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•á ‡§¨‡§æ‡§¶ Firestore ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à
        async function completePiPayment(paymentRecordId, listingId) {
            console.log(`‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ Firestore ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å: ${paymentRecordId}`);
            try {
                // A. Payment Record ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§∏‡•ç‡§•‡§ø‡§§‡§ø: paid)
                const paymentsRef = collection(db, PRIVATE_COLLECTION_PATH('payments'));
                // paymentRecordId (newPaymentId) ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º (document) ‡§ñ‡•ã‡§ú‡•á‡§Ç
                const q = query(paymentsRef, where("id", "==", paymentRecordId), limit(1));
                
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const docId = snapshot.docs[0].id;
                    await updateDoc(doc(db, PRIVATE_COLLECTION_PATH('payments'), docId), {
                        status: 'paid',
                        completedAt: serverTimestamp(),
                    });
                }

                // B. Listing Status ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç (‡§∏‡•ç‡§•‡§ø‡§§‡§ø: sold)
                const listingRef = doc(db, PUBLIC_COLLECTION_PATH('listings'), listingId);
                await updateDoc(listingRef, {
                    status: 'sold',
                    soldAt: serverTimestamp(),
                });
                
                showMessage('‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü ‡§î‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§¨‡§ø‡§ï ‡§ó‡§à!', 'green');

            } catch (error) {
                console.error("‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showMessage('‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§≤‡•á‡§®-‡§¶‡•á‡§® ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§™‡•Ç‡§∞‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§', 'red');
            }
        }
    </script>
</body>
</html>
```eof

---

## üõ†Ô∏è ‡§Ö‡§ó‡§≤‡§æ ‡§ï‡§¶‡§Æ: ‡§°‡§ø‡§™‡•ç‡§≤‡•â‡§Ø‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•ã ‡§†‡•Ä‡§ï ‡§ï‡§∞‡§®‡§æ

‡§Ø‡§π ‡§ï‡•ã‡§° **Pi SDK** ‡§ï‡•ã ‡§≠‡•Ä ‡§ú‡•ã‡§°‡§º‡§§‡§æ ‡§π‡•à (‡§≤‡§æ‡§á‡§® 8 ‡§™‡§∞), ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§Ö‡§∞‡•ç‡§• ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§°‡§ø‡§™‡•ç‡§≤‡•â‡§Ø‡§Æ‡•á‡§Ç‡§ü ‡§†‡•Ä‡§ï ‡§π‡•ã ‡§ú‡§æ‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶, ‡§Ü‡§™‡§ï‡•á **‡§≠‡•Å‡§ó‡§§‡§æ‡§® (Payment)** ‡§î‡§∞ **Pi Login** ‡§ï‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ‡§è‡§Å ‡§π‡§≤ ‡§π‡•ã ‡§ú‡§æ‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§

‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ø‡•á **‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ö‡§∞‡§£** ‡§†‡•Ä‡§ï ‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç:

1.  **GitHub Repo:** ‡§Ö‡§™‡§®‡•Ä `Barter-Pi` ‡§∞‡•á‡§™‡•ã ‡§Æ‡•á‡§Ç, **`index.html`** ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•ã **‡§∏‡•Ä‡§ß‡•á ‡§∞‡•Ç‡§ü (Root)** ‡§Æ‡•á‡§Ç ‡§á‡§∏ ‡§®‡§è ‡§ï‡•ã‡§° ‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§¶‡•á‡§Ç‡•§
2.  **Render Settings:**
    * **Root Directory** ‡§ï‡•ã **‡§ñ‡§æ‡§≤‡•Ä (Blank)** ‡§õ‡•ã‡§°‡§º ‡§¶‡•á‡§Ç‡•§
    * **Publish Directory** ‡§ï‡•ã **`.` (‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï ‡§¨‡§ø‡§Ç‡§¶‡•Å)** ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§
3.  **Deploy:** Render ‡§™‡§∞ **Manual Deploy** ‡§ï‡§∞‡•á‡§Ç‡•§

‡§Æ‡•Å‡§ù‡•á ‡§™‡•Ç‡§∞‡•Ä ‡§â‡§Æ‡•ç‡§Æ‡•Ä‡§¶ ‡§π‡•à ‡§ï‡§ø ‡§á‡§∏ ‡§¨‡§æ‡§∞ ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§æ‡§á‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä!
