<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Barter-Pi Pro: Pi E-Commerce Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Pi SDK Mock for testing -->
    <script src="https://cdn.jsdelivr.net/gh/ph0enix-dev/pi-sdk-mock@main/pi-sdk-mock.js"></script>
    
    <!-- Firebase CDNs (Required for Firestore, Auth) - IMPORTANT: We only import the dependency names. -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // This makes Firebase functions globally available IF they are initialized.
        window.firebaseDependencies = {
            initializeApp, getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, orderBy, limit,
            getStorage, ref, uploadString, getDownloadURL
        };
    </script>
    
    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pi-dark': '#1e293b', // Slate Dark
                        'pi-main': '#ffb33f', // Pi Gold
                        'pi-blue': '#1e75ff', // Pi Blue
                        'pi-light': '#fef3c7', // Light Gold Background
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        };
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Main root element for React -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { Home, Search, ShoppingCart, User, Send, Settings, MessageCircle, TrendingUp, DollarSign, Truck, Star, Info, Image, Video, Clipboard, QrCode, Shield, X, Sparkles, Wand2, RefreshCw } = lucide;

        // --- GLOBAL CONSTANTS ---
        const ADMIN_ID = 'developer_wallet_id_here'; 
        const FIRESTORE_COLLECTION_LISTINGS = 'listings';
        const FIRESTORE_COLLECTION_CHATS = 'chats';
        const FIRESTORE_COLLECTION_ORDERS = 'orders';
        const GEMINI_MODEL_TEXT = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_MODEL_IMAGE = 'imagen-3.0-generate-002';
        
        // --- MOCK DATABASE (Local Storage Fallback) ---
        const MOCK_LISTINGS_KEY = 'barter_pi_mock_listings';
        const MOCK_CHATS_KEY = 'barter_pi_mock_chats';

        const getMockData = (key, defaultData) => {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultData;
            } catch (e) {
                console.error("Error reading from LocalStorage:", e);
                return defaultData;
            }
        };

        const setMockData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error writing to LocalStorage:", e);
            }
        };
        
        const initialMockListings = [
            { id: 'm1', name: 'Pi T-Shirt (Global)', description: 'Soft cotton T-shirt with Pi logo. Shipping worldwide.', price: 10.5, userId: 'mock-seller-1', username: 'GlobalSeller', createdAt: new Date(), media: [{ url: 'https://placehold.co/400x300/1e75ff/ffffff?text=Pi+T-Shirt' }] },
            { id: 'm2', name: 'Local Handmade Craft', description: 'Unique decorative item made locally.', price: 5.0, userId: 'mock-seller-2', username: 'LocalArtisan', createdAt: new Date(), media: [{ url: 'https://placehold.co/400x300/ffb33f/1e293b?text=Handmade+Craft' }] },
            { id: 'm3', name: 'Digital Service Offer', description: 'Web design consultation (1 hour).', price: 2.0, userId: 'mock-seller-1', username: 'GlobalSeller', createdAt: new Date(), media: [{ url: 'https://placehold.co/400x300/1e293b/ffb33f?text=Web+Design' }] },
        ];
        
        // --- GEMINI API UTILITIES ---
        
        // Exponential backoff for API retries
        const fetchWithRetry = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API Error: ${response.statusText} (${response.status})`);
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                }
            }
        };

        const useGemini = () => {
            const apiKey = "";
            const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";

            // 1. Text Generation/Grounding (gemini-2.5-flash)
            const callGemini = useCallback(async (model, userPrompt, systemInstruction = '', useSearch = false, responseSchema = null) => {
                const url = `${apiUrlBase}${model}:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                };
                
                if (systemInstruction) {
                    payload.systemInstruction = { parts: [{ text: systemInstruction }] };
                }
                
                if (useSearch) {
                    payload.tools = [{ "google_search": {} }];
                }

                if (responseSchema) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema,
                    };
                }

                try {
                    const response = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    
                    if (!candidate || !candidate.content?.parts?.[0]?.text) {
                        throw new Error("Invalid response structure from Gemini API.");
                    }
                    
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                            .filter(source => source.uri && source.title);
                    }

                    return { text, sources };

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    throw new Error(`AI Request Failed: ${error.message}.`);
                }
            }, []);

            // 2. Image Generation (imagen-3.0-generate-002)
            const generateImage = useCallback(async (prompt) => {
                const url = `${apiUrlBase}${GEMINI_MODEL_IMAGE}:predict?key=${apiKey}`;
                const payload = {
                    instances: [{ prompt: prompt, aspect_ratio: "4:3" }],
                    parameters: { "sampleCount": 1 } 
                };

                try {
                    const response = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        return `data:image/png;base64,${base64Data}`;
                    } else {
                        throw new Error("Invalid image generation response.");
                    }
                } catch (error) {
                    console.error("Image Generation Error:", error);
                    throw new Error(`Image Generation Failed: ${error.message}.`);
                }
            }, []);


            return { callGemini, generateImage };
        };


        // --- Firebase/Auth Setup States (With Anti-Crash Logic) ---
        const useFirebase = () => {
            const [db, setDb] = useState(null); // Will hold the Firestore instance OR a Mock DB object
            const [auth, setAuth] = useState(null);
            const [storage, setStorage] = useState(null);
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isMockMode, setIsMockMode] = useState(false);

            useEffect(() => {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // --- ANTI-CRASH LOGIC: Check if Config is Missing/Empty ---
                if (!firebaseConfig.apiKey || !window.firebaseDependencies) {
                    console.warn("‚ùå Firebase Config/Dependencies missing. Running in STABLE MOCK MODE (Local Storage).");
                    
                    setIsMockMode(true);
                    
                    // Setup Mock User
                    const mockUser = { uid: 'mock_user_' + appId, username: 'MockUser (LS)', isAdmin: false, isMock: true };
                    setUser(mockUser);
                    
                    // Setup Mock DB (Local Storage API)
                    const mockDb = {
                        // Mock onSnapshot for Listings
                        onSnapshotListing: (callback) => {
                            const data = getMockData(MOCK_LISTINGS_KEY, initialMockListings);
                            callback(data);
                            // Mocking a passive listener (no real-time updates)
                            return () => {}; 
                        },
                        // Mock onSnapshot for Chats
                        onSnapshotChat: (callback) => {
                            const data = getMockData(MOCK_CHATS_KEY, [{id:'c1', message:'‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Ø‡§π ‡§è‡§ï ‡§®‡§ï‡§≤‡•Ä ‡§ö‡•à‡§ü ‡§π‡•à‡•§', userId:'mock-ai', username:'AI Chat'}]);
                            callback(data);
                            return () => {};
                        },
                        // Mock addDoc for Listings/Chats
                        addDoc: (collectionName, data) => {
                            return new Promise(resolve => {
                                setTimeout(() => {
                                    const key = collectionName.includes(FIRESTORE_COLLECTION_LISTINGS) ? MOCK_LISTINGS_KEY : MOCK_CHATS_KEY;
                                    const existing = getMockData(key, key === MOCK_LISTINGS_KEY ? initialMockListings : []);
                                    
                                    const newData = { 
                                        id: 'm' + Date.now(), 
                                        ...data, 
                                        createdAt: new Date(),
                                        userId: mockUser.uid,
                                        username: mockUser.username,
                                    };
                                    const updatedData = [newData, ...existing];

                                    setMockData(key, updatedData);
                                    
                                    // Manually update state for MOCK UI (important for immediate refresh)
                                    if (key === MOCK_LISTINGS_KEY) {
                                        // This is a simplified approach, real React Context would be better
                                        window.dispatchEvent(new CustomEvent('mockListingUpdate'));
                                    }
                                    if (key === MOCK_CHATS_KEY) {
                                        window.dispatchEvent(new CustomEvent('mockChatUpdate'));
                                    }

                                    resolve({ id: newData.id });
                                }, 500);
                            });
                        },
                    };
                    
                    setDb(mockDb);
                    setIsAuthReady(true);
                    return;
                }

                // --- REAL FIREBASE SETUP (If config is present) ---
                const { initializeApp, getAuth, getFirestore, signInWithCustomToken, onAuthStateChanged, signInAnonymously, getStorage } = window.firebaseDependencies;
                
                try {
                    const app = initializeApp(firebaseConfig);
                    const fAuth = getAuth(app);
                    const fDb = getFirestore(app);
                    const fStorage = getStorage(app);
                    
                    setAuth(fAuth);
                    setDb(fDb);
                    setStorage(fStorage);
                    
                    // Authentication Logic (Crucial for Pi App)
                    const unsubscribe = onAuthStateChanged(fAuth, async (currentUser) => {
                        if (currentUser) {
                            let piUser = {
                                uid: currentUser.uid,
                                username: currentUser.isAnonymous ? 'Anonymous' : currentUser.uid.substring(0, 8),
                                isAdmin: currentUser.uid === ADMIN_ID,
                                isMock: false,
                            };
                            setUser(piUser);
                            setIsAuthReady(true);
                        } else {
                            // Attempt initial sign-in using provided token
                            try {
                                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                                if (token) {
                                    await signInWithCustomToken(fAuth, token);
                                } else {
                                    await signInAnonymously(fAuth);
                                }
                            } catch (error) {
                                console.error("Firebase Authentication Error (Check Render Variables & Pi SDK):", error.message);
                                // If auth fails, still set auth ready to allow UI to render (with minimal access)
                                setIsAuthReady(true); 
                            }
                        }
                    });

                    return () => unsubscribe(); // Cleanup auth listener

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    setIsAuthReady(true); // Ensure UI renders even if Firebase fails
                }
            }, []);

            return { db, auth, storage, user, isAuthReady, isMockMode };
        };

        // --- Converter Utility (Pi Price Mock) ---
        const useConverter = () => {
            const [piPrice, setPiPrice] = useState('N/A');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                setTimeout(() => {
                    setPiPrice('~$35 USD (Current Consensus)');
                    setLoading(false);
                }, 1500);
            }, []);

            return { piPrice, loading };
        };

        // --- Component: Header & Nav (No changes needed) ---
        const Header = ({ user, isAdmin, onSignOut, navigate, currentPage }) => {
            const navItems = [
                { id: 'deals', label: 'Main Deals', icon: TrendingUp },
                { id: 'listings', label: 'Listings', icon: ShoppingCart },
                { id: 'chat', label: 'Chat Box', icon: MessageCircle },
                { id: 'ai', label: 'AI Helper', icon: Info },
            ];

            if (isAdmin) {
                navItems.push({ id: 'admin', label: 'Admin', icon: Settings });
            }

            return (
                <header className="bg-pi-dark shadow-xl sticky top-0 z-30">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                        <h1 onClick={() => navigate('deals')} className="text-3xl font-extrabold text-white tracking-wider cursor-pointer">
                            Barter<span className="text-pi-main">-Pi Pro</span>
                        </h1>
                        
                        {/* Desktop Nav */}
                        <nav className="hidden md:flex items-center space-x-6">
                            {navItems.map(item => {
                                const Icon = item.icon;
                                const isActive = currentPage === item.id;
                                return (
                                    <button 
                                        key={item.id}
                                        onClick={() => navigate(item.id)}
                                        className={`flex items-center space-x-1 py-2 px-3 rounded-lg font-medium transition ${
                                            isActive 
                                                ? 'bg-pi-main text-pi-dark shadow-md' 
                                                : 'text-gray-300 hover:bg-gray-700'
                                        }`}
                                    >
                                        <Icon size={18} />
                                        <span>{item.label}</span>
                                    </button>
                                );
                            })}
                        </nav>

                        {/* User Info & Auth */}
                        <div className="flex items-center space-x-3">
                            {user && (
                                <span className="text-white text-sm hidden sm:block">
                                    <User size={16} className="inline-block mr-1" />
                                    {user.username} | {isAdmin && <span className="text-red-400 font-bold">ADMIN</span>}
                                </span>
                            )}
                            <button 
                                onClick={onSignOut} 
                                className={'bg-red-500 text-white hover:bg-red-600 font-semibold py-2 px-3 rounded-lg transition shadow-lg text-sm'}
                            >
                                {user ? 'Sign Out' : 'Sign In'}
                            </button>
                        </div>
                    </div>

                    {/* Mobile Nav */}
                    <nav className="md:hidden flex justify-around border-t border-gray-700 pt-2 pb-1 bg-pi-dark">
                        {navItems.map(item => {
                            const Icon = item.icon;
                            const isActive = currentPage === item.id;
                            return (
                                <button 
                                    key={item.id}
                                    onClick={() => navigate(item.id)}
                                    className={`flex flex-col items-center p-2 rounded-lg transition text-xs ${
                                        isActive 
                                            ? 'text-pi-main' 
                                            : 'text-gray-400 hover:text-white'
                                    }`}
                                >
                                    <Icon size={20} />
                                    <span>{item.label}</span>
                                </button>
                            );
                        })}
                    </nav>
                </header>
            );
        };

        // --- Component: Main Deals/Listings (No functional change) ---
        const DealsPage = ({ db, user, storage, navigate, piPrice, isMockMode, callGemini, generateImage }) => {
            const [listings, setListings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const { collection, query, onSnapshot, orderBy, limit } = window.firebaseDependencies || {};
            
            // Local Storage/Firestore Data Listener
            useEffect(() => {
                setLoading(true);

                if (isMockMode) {
                    // MOCK MODE: Use Local Storage/Mock API
                    const handleUpdate = () => {
                        const data = getMockData(MOCK_LISTINGS_KEY, initialMockListings);
                        setListings(data);
                        setLoading(false);
                    };
                    
                    handleUpdate(); // Initial Load
                    window.addEventListener('mockListingUpdate', handleUpdate);
                    return () => window.removeEventListener('mockListingUpdate', handleUpdate);

                } else if (db && user && !user.isMock) {
                    // FIREBASE MODE: Use Real Firestore
                    const q = query(
                        collection(db, `artifacts/${__app_id}/public/data/${FIRESTORE_COLLECTION_LISTINGS}`),
                        orderBy('createdAt', 'desc'),
                        limit(50)
                    );

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedListings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setListings(fetchedListings);
                        setLoading(false);
                    }, (error) => {
                        console.error("Error fetching listings (FIREBASE):", error);
                        setLoading(false);
                    });

                    return () => unsubscribe();
                }

                // Fallback for non-mock, non-auth state
                setLoading(false);
            }, [db, user, isMockMode]);

            const filteredListings = listings.filter(l =>
                l.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                l.description?.toLowerCase().includes(searchQuery.toLowerCase())
            );

            // Mock/Real Payment Handler (No change, uses Pi Mock SDK)
            const handleBarterClick = (listing) => {
                // ... (Payment logic remains the same)
                if (!user || user.isMock) {
                    alert('Mock User: Sign in with real Pi or switch to a Firebase environment to proceed to real payment.');
                    return;
                }
                
                alert(`Barter initiated for ${listing.name} at ${listing.price}œÄ. Starting Pi Payment SDK.`);
                
                Pi.createPayment({
                    amount: listing.price,
                    memo: `Barter for ${listing.name} (ID: ${listing.id})`,
                    metadata: { listingId: listing.id, buyerId: user.uid },
                }, {
                    onReadyForServerApproval: (paymentId) => {
                        console.log(`Payment Ready: ${paymentId}`);
                    },
                    onPaymentCompleted: (paymentId, txid) => {
                        alert(`üéâ ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§∏‡§´‡§≤! TxID: ${txid}. ‡§Ö‡§¨ 'Orders' ‡§™‡•á‡§ú ‡§™‡§∞ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§`);
                    },
                    onPaymentCancelled: () => {
                        alert("‚ùå ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§∞‡§¶‡•ç‡§¶ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§");
                    },
                    onError: (error) => {
                        alert(`‚ùå ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§è‡§∞‡§∞: ${error.message}`);
                    }
                });
            };

            return (
                <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                    
                    {isMockMode && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 shadow-md">
                            <p className="font-bold">‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: Local Storage Mode</p>
                            <p className="text-sm">Firebase Variables ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§ ‡§°‡•á‡§ü‡§æ Local Storage (‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞) ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à, ‡§ú‡•ã ‡§∏‡§≠‡•Ä ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§∏‡§æ‡§ù‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ‡•§ Firebase ‡§†‡•Ä‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Variables ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§</p>
                        </div>
                    )}

                    {/* Header & Controls */}
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-3xl font-bold text-pi-dark">
                            <TrendingUp className="inline-block mr-2 text-pi-main" size={28} /> Main Deals ({listings.length})
                        </h2>
                        <button 
                            onClick={() => setIsModalOpen(true)}
                            disabled={!user}
                            className={`font-semibold py-2 px-4 rounded-lg transition shadow-lg text-white ${
                                user ? 'bg-pi-blue hover:bg-blue-600' : 'bg-gray-400 cursor-not-allowed'
                            }`}
                        >
                            + ‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                        </button>
                    </div>

                    {/* Search Bar */}
                    <div className="relative flex-grow mb-8">
                        <input 
                            type="text" 
                            placeholder="‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤/‡§≤‡•ã‡§ï‡§≤ ‡§°‡•Ä‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç (‡§®‡§æ‡§Æ, ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§ü‡•à‡§ó)..." 
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full p-4 border border-gray-300 rounded-xl focus:ring-pi-main focus:border-pi-main pl-12 transition shadow-inner"
                        />
                        <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                    </div>

                    {/* Listings Grid */}
                    {loading ? (
                        <p className="text-center text-pi-blue my-10 text-xl font-medium">‚ú® ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            {filteredListings.length === 0 ? (
                                <p className="text-center text-gray-500 my-10 text-xl col-span-full">‡§ï‡•ã‡§à ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</p>
                            ) : (
                                filteredListings.map(listing => (
                                    <ListingCard 
                                        key={listing.id} 
                                        listing={listing} 
                                        user={user} 
                                        onBarterClick={handleBarterClick}
                                        navigate={navigate}
                                    />
                                ))
                            )}
                        </div>
                    )}
                    
                    <NewListingModal 
                        isModalOpen={isModalOpen} 
                        setIsModalOpen={setIsModalOpen} 
                        db={db}
                        user={user}
                        storage={storage}
                        collectionName={FIRESTORE_COLLECTION_LISTINGS}
                        isMockMode={isMockMode}
                        callGemini={callGemini}
                        generateImage={generateImage}
                    />

                </div>
            );
        };

        // --- Component: Listing Card (No change) ---
        const ListingCard = ({ listing, user, onBarterClick, navigate }) => {
            const isOwner = user?.uid === listing.userId;
            const imageUrl = listing.media?.[0]?.url || 'https://placehold.co/400x300/fec84d/1e293b?text=Barter-Pi';
            
            const handleQRClick = () => {
                alert(`QR Code Mock: Listing ID ${listing.id} | Price ${listing.price}œÄ. In a real app, this generates a QR image.`);
            }

            return (
                <div className="bg-white rounded-xl shadow-2xl overflow-hidden transform hover:scale-[1.02] transition duration-300 flex flex-col">
                    {/* Image Placeholder */}
                    <div className="h-48 bg-gray-200 relative">
                        <img 
                            src={imageUrl} 
                            alt={listing.name} 
                            className="w-full h-full object-cover"
                            onError={(e) => e.target.src = 'https://placehold.co/400x300/fec84d/1e293b?text=Barter-Pi+Image+Missing'}
                        />
                        <button 
                            onClick={handleQRClick}
                            className="absolute top-2 right-2 bg-white p-2 rounded-full shadow-lg hover:bg-gray-100 transition"
                            title="QR Code Payment"
                        >
                            <QrCode size={18} className="text-pi-dark" />
                        </button>
                    </div>

                    {/* Content */}
                    <div className="p-5 flex flex-col flex-grow">
                        <h3 className="text-xl font-bold text-pi-dark truncate mb-1">{listing.name}</h3>
                        <p className="text-sm text-gray-600 mb-3 line-clamp-2 flex-grow">{listing.description}</p>
                        
                        <div className="flex items-center text-sm text-gray-500 mb-4">
                            <Star size={14} className="text-yellow-500 mr-1 fill-yellow-500" /> 4.5 ({Math.floor(Math.random() * 100) + 10} Reviews)
                        </div>

                        {/* Price & Action */}
                        <div className="mt-auto flex justify-between items-center border-t pt-3">
                            <span className="text-3xl font-extrabold text-pi-main">
                                {listing.price} <span className="text-lg font-medium text-gray-600">œÄ</span>
                            </span>
                            <button 
                                onClick={() => onBarterClick(listing)} 
                                disabled={isOwner || !user}
                                className={`text-white text-sm font-semibold py-2 px-4 rounded-lg transition shadow-md ${
                                    isOwner 
                                        ? 'bg-gray-400 cursor-not-allowed' 
                                        : 'bg-pi-blue hover:bg-blue-600 disabled:bg-gray-500'
                                }`}
                            >
                                {isOwner ? '‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å' : 'Barter & Buy'}
                            </button>
                        </div>
                        <button 
                            onClick={() => navigate('order', { listingId: listing.id, isBuyer: true })} 
                            className="mt-2 text-pi-blue hover:underline text-xs text-right"
                        >
                            ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä/‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£
                        </button>
                    </div>
                </div>
            );
        };


        // --- Component: New Listing Modal (Seller UI) ---
        const NewListingModal = ({ isModalOpen, setIsModalOpen, db, user, storage, collectionName, isMockMode, callGemini, generateImage }) => {
            if (!isModalOpen) return null;

            const [name, setName] = useState('');
            const [description, setDescription] = useState('');
            const [price, setPrice] = useState('');
            const [mediaType, setMediaType] = useState('image'); // 'image' or 'video'
            const [mediaData, setMediaData] = useState(''); // Base64 or URL
            const [loading, setLoading] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const { addDoc, collection, serverTimestamp, ref, uploadString, getDownloadURL } = window.firebaseDependencies || {};
            
            // --- GEMINI FEATURE 1: Product Description Generator ---
            const descriptionSchema = {
                type: "OBJECT",
                properties: {
                    "productName": { "type": "STRING", "description": "A compelling, short product name in Hindi." },
                    "description": { "type": "STRING", "description": "A detailed, sales-oriented product description in Hindi." },
                    "tags": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "3 to 5 relevant tags for searching." }
                },
                "propertyOrdering": ["productName", "description", "tags"]
            };

            const generateContent = async () => {
                if (!name.trim()) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§');
                setAiLoading(true);
                
                const prompt = `Based on the product name or keywords: "${name}", generate a short, compelling product name (productName), a detailed, sales-oriented product description (description), and 5 relevant search tags (tags). The output language for the name and description MUST be Hindi. The tags can be mixed Hindi/English.`;

                try {
                    const { text } = await callGemini(GEMINI_MODEL_TEXT, prompt, '', false, descriptionSchema);
                    const parsedJson = JSON.parse(text);
                    
                    setName(parsedJson.productName || name);
                    setDescription(parsedJson.description || "‡§µ‡§ø‡§µ‡§∞‡§£ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤ ‡§∞‡§π‡§æ‡•§");
                    // Tags would ideally be stored separately but for this app, we'll just log them.
                    console.log("Generated Tags:", parsedJson.tags.join(', '));

                } catch (error) {
                    alert(`‚ùå AI Content Generation Failed: ${error.message}`);
                    setDescription("AI ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§");
                } finally {
                    setAiLoading(false);
                }
            };
            
            // --- GEMINI FEATURE 2: Summarization ---
            const summarizeDescription = async () => {
                if (description.length < 50) return alert('‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™ (summary) ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 50 ‡§Ö‡§ï‡•ç‡§∑‡§∞ ‡§≤‡§Ç‡§¨‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§');
                setAiLoading(true);
                
                const prompt = `Summarize the following product description in one single, concise paragraph (max 50 words) in Hindi. Description: ${description}`;

                try {
                    const { text } = await callGemini(GEMINI_MODEL_TEXT, prompt);
                    alert(`‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£ (Summary): \n\n${text}`);
                } catch (error) {
                    alert(`‚ùå AI Summarization Failed: ${error.message}`);
                } finally {
                    setAiLoading(false);
                }
            };

            // --- GEMINI FEATURE 3: Image Generation ---
            const generateProductImage = async () => {
                if (!name.trim() || !description.trim()) return alert('AI Image ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§');
                setAiLoading(true);

                const imagePrompt = `A 3D render of "${name}, ${description.substring(0, 100)}", photo-realistic, soft studio lighting, on a simple light background, suitable for e-commerce.`;
                
                try {
                    const imageUrl = await generateImage(imagePrompt);
                    setMediaData(imageUrl); // Set the generated image as the media data
                    setMediaType('image');
                    alert('‚ú® AI Image ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•Å‡§à!');
                } catch (error) {
                    alert(`‚ùå AI Image Generation Failed: ${error.message}`);
                    setMediaData('');
                } finally {
                    setAiLoading(false);
                }
            };


            // Simulating image upload by converting string to base64
            const handleMediaChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setMediaData(reader.result); // Base64 string
                    };
                    reader.readAsDataURL(file);
                }
            };

            const uploadMedia = async (fileBase64) => {
                // Mock or Real Storage Upload
                if (isMockMode) {
                    console.log("Mock Storage: Image/Video data received, but not uploaded to a persistent storage.");
                    return 'https://placehold.co/400x300/6b7280/ffffff?text=Mock+Media+Uploaded';
                }

                const storageRef = ref(storage, `listings/${user.uid}/${Date.now()}`);
                const snapshot = await uploadString(storageRef, fileBase64, 'data_url');
                return await getDownloadURL(snapshot.ref);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (parseFloat(price) <= 0 || !db || !user) return alert('‡§ï‡•Ä‡§Æ‡§§ 0 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§π‡•ã‡§®‡•Ä ‡§ö‡§æ‡§π‡§ø‡§è‡•§');
                setLoading(true);

                try {
                    let mediaUrl = '';
                    if (mediaData) {
                        mediaUrl = await uploadMedia(mediaData); // Upload (Mock or Real)
                    }

                    const newListing = {
                        name,
                        description,
                        price: parseFloat(price),
                        userId: user.uid,
                        username: user.username,
                        media: mediaUrl ? [{ type: mediaType, url: mediaUrl }] : [],
                        status: 'available',
                        isLocal: false,
                    };

                    if (isMockMode) {
                        await db.addDoc(collectionName, newListing);
                    } else {
                        // Real Firebase addDoc
                        await addDoc(collection(db, `artifacts/${__app_id}/public/data/${collectionName}`), {
                            ...newListing,
                            createdAt: serverTimestamp(),
                        });
                    }

                    alert('‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡•Å‡§à!');
                    setIsModalOpen(false);
                } catch (error) {
                    console.error("Posting error:", error);
                    alert(`‚ùå ‡§™‡•ã‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§µ‡§ø‡§´‡§≤: ${error.message}.`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-3">
                            <h3 className="text-2xl font-bold text-pi-dark">‡§µ‡§ø‡§ï‡•ç‡§∞‡•á‡§§‡§æ UI: ‡§®‡§à ‡§µ‡§∏‡•ç‡§§‡•Å ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h3>
                            <button onClick={() => setIsModalOpen(false)} className="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            {/* Product Details */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§Ø‡§æ Keywords)</label>
                                    <input type="text" required value={name} onChange={(e) => setName(e.target.value)} className="p-3 w-full border border-gray-300 rounded-lg focus:ring-pi-main focus:border-pi-main shadow-sm" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Pi ‡§Æ‡•á‡§Ç ‡§ï‡•Ä‡§Æ‡§§ (œÄ)</label>
                                    <input type="number" step="0.0001" required min="0.0001" value={price} onChange={(e) => setPrice(e.target.value)} className="p-3 w-full border border-gray-300 rounded-lg focus:ring-pi-main focus:border-pi-main shadow-sm" />
                                </div>
                            </div>
                            
                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700 mb-1">‡§µ‡§ø‡§µ‡§∞‡§£ (Description)</label>
                                <textarea required value={description} onChange={(e) => setDescription(e.target.value)} className="p-3 w-full border border-gray-300 rounded-lg h-24 focus:ring-pi-main focus:border-pi-main shadow-sm"></textarea>
                            </div>

                            {/* Gemini Content Buttons */}
                            <div className="mt-4 flex flex-wrap gap-3">
                                <button 
                                    type="button" 
                                    onClick={generateContent} 
                                    disabled={aiLoading}
                                    className={`flex items-center text-sm font-semibold py-2 px-4 rounded-full transition shadow-md ${aiLoading ? 'bg-gray-400' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                                >
                                    {aiLoading ? <RefreshCw size={16} className="animate-spin mr-2" /> : <Sparkles size={16} className="mr-2" />}
                                    ‡§µ‡§ø‡§µ‡§∞‡§£/‡§®‡§æ‡§Æ ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‚ú®
                                </button>
                                <button 
                                    type="button" 
                                    onClick={summarizeDescription} 
                                    disabled={aiLoading || description.length < 50}
                                    className={`flex items-center text-sm font-semibold py-2 px-4 rounded-full transition shadow-md ${aiLoading || description.length < 50 ? 'bg-gray-400' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'}`}
                                >
                                    <Clipboard size={16} className="mr-2" />
                                    ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™ (Summary) ‡§¶‡•á‡§ñ‡•á‡§Ç
                                </button>
                            </div>


                            {/* Image/Video Upload */}
                            <div className="mt-6 border p-4 rounded-xl bg-gray-50">
                                <h4 className="text-lg font-semibold mb-3">‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§æ ‡§Ö‡§™‡§≤‡•ã‡§° (‡§õ‡§µ‡§ø/‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã)</h4>
                                
                                <div className="flex flex-wrap gap-3 mb-4">
                                    <label className="flex items-center text-sm">
                                        <input type="radio" name="mediaType" value="image" checked={mediaType === 'image'} onChange={() => setMediaType('image')} className="mr-2 text-pi-main" />
                                        <Image size={16} className="mr-1 inline" /> Image (Upload)
                                    </label>
                                    <label className="flex items-center text-sm">
                                        <input type="radio" name="mediaType" value="video" checked={mediaType === 'video'} onChange={() => setMediaType('video')} className="mr-2 text-pi-main" />
                                        <Video size={16} className="mr-1 inline" /> Video (Mock Upload)
                                    </label>
                                    <button 
                                        type="button" 
                                        onClick={generateProductImage} 
                                        disabled={aiLoading}
                                        className={`flex items-center text-sm font-semibold py-1 px-3 rounded-full transition shadow-md ${aiLoading ? 'bg-gray-400' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                                    >
                                        {aiLoading ? <RefreshCw size={14} className="animate-spin mr-1" /> : <Wand2 size={14} className="mr-1" />}
                                        AI Image ‡§¨‡§®‡§æ‡§ì ‚ú®
                                    </button>
                                </div>

                                {mediaType === 'image' && (
                                    <input 
                                        type="file" 
                                        accept="image/*" 
                                        onChange={handleMediaChange} 
                                        className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pi-light file:text-pi-dark hover:file:bg-yellow-100"
                                    />
                                )}
                                
                                {mediaData && (
                                    <div className="mt-4 p-2 border rounded-lg bg-white flex items-center">
                                        <img src={mediaData} alt="Media Preview" className="w-16 h-16 object-cover rounded mr-3" />
                                        <p className="text-xs text-green-600 truncate flex-1">‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§æ ‡§ö‡§Ø‡§®‡§ø‡§§/‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§°‡•§ {mediaData.length > 100 ? '(Base64 Data)' : '(External URL)'}</p>
                                    </div>
                                )}
                                
                            </div>

                            {/* Developer Wallet Note */}
                            <div className="mt-6 p-3 bg-red-50 border-l-4 border-red-500 text-red-700 rounded">
                                <p className="text-sm">
                                    <Shield size={16} className="inline-block mr-1" /> **Security Note:** ‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó ‡§Ø‡•Ç‡§ú‡§º‡§∞ ID: <span className="font-mono">{user?.uid}</span> ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•Ä ‡§π‡•ã‡§ó‡•Ä‡•§
                                </p>
                            </div>

                            <div className="flex justify-end space-x-4 mt-6">
                                <button type="submit" disabled={loading} className={`text-white font-semibold py-3 px-6 rounded-lg transition shadow-md ${loading ? 'bg-gray-500' : 'bg-pi-main text-pi-dark hover:bg-yellow-400'}`}>
                                    {loading ? '‡§™‡•ã‡§∏‡•ç‡§ü ‡§π‡•ã ‡§∞‡§π‡•Ä...' : <><Send size={18} className="inline-block mr-1" /> ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</>}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };


        // --- Component: Chat Box Page (No functional change) ---
        const ChatPage = ({ db, user, isMockMode }) => {
            const [chatType, setChatType] = useState('public');
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const chatPath = `artifacts/${__app_id}/public/data/${FIRESTORE_COLLECTION_CHATS}`;
            const { addDoc, collection, query, onSnapshot, orderBy, limit, serverTimestamp } = window.firebaseDependencies || {};
            
            // Fetch messages (Mock or Real)
            useEffect(() => {
                if (!db || !user) return;
                
                if (isMockMode) {
                    // MOCK MODE: Use Local Storage/Mock API
                    const handleUpdate = () => {
                        const data = getMockData(MOCK_CHATS_KEY, [{id:'c1', message:'‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Ø‡§π ‡§è‡§ï ‡§®‡§ï‡§≤‡•Ä ‡§ö‡•à‡§ü ‡§π‡•à‡•§', userId:'mock-ai', username:'AI Chat'}]);
                        // Filter by mock chatType (very basic mock)
                        setMessages(data.reverse()); 
                    };
                    handleUpdate(); // Initial Load
                    window.addEventListener('mockChatUpdate', handleUpdate);
                    return () => window.removeEventListener('mockChatUpdate', handleUpdate);

                } else {
                    // FIREBASE MODE: Use Real Firestore
                    const q = query(
                        collection(db, chatPath),
                        where('type', '==', chatType),
                        orderBy('createdAt', 'desc'),
                        limit(50)
                    );

                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const fetchedMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).reverse();
                        setMessages(fetchedMessages);
                    }, (error) => {
                        console.error("Chat fetch error:", error);
                    });

                    return () => unsubscribe();
                }

            }, [db, user, chatType, isMockMode]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!message.trim() || !db) return;

                const messageData = {
                    userId: user.uid,
                    username: user.username || user.uid.substring(0, 8),
                    message: message.trim(),
                    type: chatType,
                };
                
                try {
                    if (isMockMode) {
                        await db.addDoc(FIRESTORE_COLLECTION_CHATS, messageData);
                    } else {
                        await addDoc(collection(db, chatPath), {
                            ...messageData,
                            createdAt: serverTimestamp(),
                        });
                    }
                    setMessage('');
                } catch (error) {
                    alert(`‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: ${error.message}`);
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-xl shadow-2xl mt-8">
                    <h2 className="text-3xl font-bold text-pi-dark mb-6 border-b pb-3 flex items-center"><MessageCircle size={28} className="mr-2 text-pi-blue" /> Chat Box</h2>
                    
                    {/* Chat Type Selector */}
                    <div className="flex mb-4 space-x-4 border-b pb-2">
                        <button onClick={() => setChatType('public')} className={`py-2 px-4 rounded-lg font-semibold transition ${chatType === 'public' ? 'bg-pi-main text-pi-dark shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                            Public Chat (Global)
                        </button>
                        <button onClick={() => setChatType('private')} className={`py-2 px-4 rounded-lg font-semibold transition ${chatType === 'private' ? 'bg-pi-main text-pi-dark shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                            Private Chat (1-on-1 Mock)
                        </button>
                    </div>

                    {/* Message Display Area */}
                    <div className="h-[50vh] overflow-y-auto border border-gray-300 rounded-xl p-4 mb-4 bg-gray-50 flex flex-col-reverse space-y-4 space-y-reverse hide-scrollbar">
                        {messages.map((msg) => (
                            <div key={msg.id} className={`flex ${msg.userId === user?.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[75%] p-3 rounded-xl shadow-md ${msg.userId === user?.uid ? 'bg-pi-blue text-white rounded-br-none' : 'bg-white text-pi-dark rounded-tl-none border'}`}>
                                    <p className="font-semibold text-xs opacity-80">{msg.username}</p>
                                    <p className="text-sm">{msg.message}</p>
                                    <span className="block text-[10px] text-right mt-1 opacity-70">
                                        {msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString('hi-IN') : '‡§Ö‡§≠‡•Ä'}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Message Input */}
                    <form onSubmit={sendMessage} className="flex space-x-3">
                        <input 
                            type="text" 
                            value={message} 
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder={user ? "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." : "‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡•Ç‡§ú‡§º‡§∞ ID ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à)"}
                            disabled={!user || isMockMode} // Chatting disabled in Mock Mode to prevent data loss confusion
                            className="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-pi-main focus:border-pi-main shadow-inner disabled:bg-gray-100"
                        />
                        <button 
                            type="submit" 
                            disabled={!user || !message.trim() || isMockMode}
                            className="bg-pi-main text-pi-dark font-semibold p-3 rounded-xl hover:bg-yellow-400 transition shadow-md disabled:bg-gray-300 disabled:text-gray-500"
                        >
                            <Send size={24} />
                        </button>
                    </form>
                    {isMockMode && <p className="text-red-500 text-sm mt-2">‡§ö‡•à‡§ü‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è Firebase ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§ Mock Mode ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§</p>}
                </div>
            );
        };

        // --- Component: AI Helper Page (Real Gemini Search & Grounding) ---
        const AIHelperPage = ({ piPrice, loading: converterLoading, callGemini }) => {
            const [query, setQuery] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [conversionAmount, setConversionAmount] = useState(1);
            const [sources, setSources] = useState([]);
            const exchangeRate = 35; // Mock Exchange Rate

            const handleAskAI = async () => {
                if (!query.trim()) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§');
                setAiLoading(true);
                setAiResponse('');
                setSources([]);

                const userQuery = query.trim();
                setQuery(''); // Clear input immediately

                const systemInstruction = "You are a helpful and knowledgeable e-commerce assistant specializing in the Pi Network ecosystem and global market trends. Answer the user's question concisely in Hindi, using information from Google Search for grounding. Include a disclaimer at the end about the nature of the information.";
                
                try {
                    const { text, sources: newSources } = await callGemini(
                        GEMINI_MODEL_TEXT, 
                        userQuery, 
                        systemInstruction, 
                        true // useSearch = true
                    );
                    setAiResponse(text);
                    setSources(newSources);

                } catch (error) {
                    setAiResponse(`‚ùå AI ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
                } finally {
                    setAiLoading(false);
                }
            };

            const convertedValue = (conversionAmount * exchangeRate).toFixed(2);

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-xl shadow-2xl mt-8">
                    <h2 className="text-3xl font-bold text-pi-dark mb-6 border-b pb-3 flex items-center"><Info size={28} className="mr-2 text-pi-main" /> AI Assistant (Real-time Search)</h2>
                    
                    {/* Pi Price Converter */}
                    <div className="mb-8 p-5 border border-gray-200 rounded-xl bg-pi-light shadow-inner">
                        <h3 className="text-xl font-bold text-pi-dark mb-3 flex items-center"><DollarSign size={20} className="mr-2" /> Pi Price Converter</h3>
                        <p className="text-sm text-gray-700 mb-4">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Pi ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Mock): <span className="font-bold text-green-600">{piPrice}</span></p>
                        <div className="flex items-center space-x-4">
                            <input 
                                type="number" 
                                value={conversionAmount} 
                                onChange={(e) => setConversionAmount(parseFloat(e.target.value) || 0)}
                                className="p-3 border border-gray-300 rounded-lg w-24 text-center focus:ring-pi-blue focus:border-pi-blue"
                                min="0"
                            />
                            <span className="text-2xl font-bold text-pi-dark">œÄ</span>
                            <span className="text-2xl font-bold text-pi-dark">=</span>
                            <span className="text-3xl font-extrabold text-green-700">${convertedValue} USD</span>
                        </div>
                    </div>

                    {/* AI Chat Box */}
                    <div className="mb-6">
                        <h3 className="text-xl font-bold text-pi-dark mb-3 flex items-center">
                            AI ‡§∏‡•á ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü/Pi ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç ‚ú® (Gemini Search)
                        </h3>
                        <div className="h-40 overflow-y-auto border border-gray-300 rounded-xl p-4 mb-4 bg-gray-50">
                            {aiLoading ? (
                                <p className="text-pi-blue flex items-center font-medium">
                                    <RefreshCw size={16} className="animate-spin mr-2" /> AI ‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ Google ‡§™‡§∞ ‡§ñ‡•ã‡§ú ‡§∞‡§π‡§æ ‡§π‡•à...
                                </p>
                            ) : aiResponse ? (
                                <>
                                    <p className="text-gray-800 text-sm whitespace-pre-wrap">{aiResponse}</p>
                                    {sources.length > 0 && (
                                        <div className="mt-3 border-t pt-2">
                                            <p className="text-xs font-semibold text-gray-600 mb-1">Sources:</p>
                                            {sources.map((source, index) => (
                                                <a 
                                                    key={index} 
                                                    href={source.uri} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer" 
                                                    className="block text-xs text-pi-blue hover:underline truncate"
                                                >
                                                    {source.title}
                                                </a>
                                            ))}
                                        </div>
                                    )}
                                </>
                            ) : (
                                <p className="text-gray-500 text-sm">‡§ú‡•à‡§∏‡•á: 'Pi Network ‡§ï‡•Ä ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§ò‡•ã‡§∑‡§£‡§æ‡§è‡§Å ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?' ‡§Ø‡§æ '‡§Ü‡§ú Pi Barter market ‡§ï‡§æ ‡§ï‡•ç‡§Ø‡§æ ‡§ö‡§≤‡§® ‡§π‡•à?'</p>
                            )}
                        </div>
                        <div className="flex space-x-3">
                            <input 
                                type="text" 
                                value={query} 
                                onChange={(e) => setQuery(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && handleAskAI()}
                                placeholder="‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç..."
                                disabled={aiLoading}
                                className="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-pi-main focus:border-pi-main shadow-inner disabled:bg-gray-100"
                            />
                            <button 
                                onClick={handleAskAI}
                                disabled={aiLoading || !query.trim()}
                                className="bg-pi-blue text-white font-semibold p-3 rounded-xl hover:bg-blue-600 transition shadow-md disabled:bg-gray-400"
                            >
                                {aiLoading ? '...' : <Send size={24} />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Component: Order/Delivery Tracking (No change) ---
        const OrderPage = ({ db, user, params }) => {
            const [orderStatus, setOrderStatus] = useState('Placed'); // Placed, Shipped, OutForDelivery, Delivered
            const [deliveryAddress, setDeliveryAddress] = useState('');
            const [review, setReview] = useState('');
            const [isReviewSubmitted, setIsReviewSubmitted] = useState(false);
            
            // Mock Data for the selected listing
            const listing = { 
                id: params?.listingId || 'mock-id-123', 
                name: 'Example Product (ID: ' + (params?.listingId || '...'), 
                sellerId: 'seller_pi_id',
                isBuyer: params?.isBuyer || false,
            };

            const handleAddressSubmit = (e) => {
                e.preventDefault();
                alert(`‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§™‡§§‡§æ ‡§∏‡•á‡§µ ‡§π‡•Å‡§Ü: ${deliveryAddress}`);
                // In a real app, this updates the order document in Firestore
            };

            const handleStatusCheck = () => {
                alert(`‡§ë‡§∞‡•ç‡§°‡§∞ ${listing.name} ‡§ï‡§æ ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏: ${orderStatus}`);
                // In a real app, this fetches status from Firestore
            };

            const handleReviewSubmit = (e) => {
                e.preventDefault();
                alert(`‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§π‡•Å‡§à: ${review}. Seller: ${listing.sellerId}`);
                setIsReviewSubmitted(true);
                // In a real app, this adds a review doc to Firestore
            };

            const deliverySteps = ['Placed', 'Shipped', 'Out For Delivery', 'Delivered'];
            const currentStepIndex = deliverySteps.indexOf(orderStatus);

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-xl shadow-2xl mt-8">
                    <h2 className="text-3xl font-bold text-pi-dark mb-6 border-b pb-3 flex items-center"><Truck size={28} className="mr-2 text-pi-blue" /> ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó & ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ</h2>
                    <p className="text-xl font-medium text-gray-700 mb-6">‡§â‡§§‡•ç‡§™‡§æ‡§¶: {listing.name}</p>

                    {/* Delivery Status Check */}
                    <div className="mb-8 p-5 border border-gray-200 rounded-xl bg-gray-50">
                        <h3 className="text-xl font-bold text-pi-dark mb-4 flex items-center"><Clipboard size={20} className="mr-2" /> ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</h3>
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={handleStatusCheck} className="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition shadow-md">
                                ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç
                            </button>
                        </div>
                        
                        {/* Status Timeline */}
                        <div className="mt-6 flex justify-between relative">
                            <div className="absolute top-1/2 left-0 right-0 h-1 bg-gray-300 z-0 transform -translate-y-1/2"></div>
                            {deliverySteps.map((step, index) => (
                                <div key={step} className="text-center relative z-10">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-2 ${
                                        index <= currentStepIndex ? 'bg-pi-main text-pi-dark shadow-xl' : 'bg-gray-400 text-white'
                                    }`}>
                                        {index + 1}
                                    </div>
                                    <p className={`text-xs font-medium ${index === currentStepIndex ? 'text-pi-dark font-bold' : 'text-gray-500'}`}>{step}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Buyer: Address Input */}
                    {listing.isBuyer && (
                        <div className="mb-8 p-5 border border-gray-200 rounded-xl">
                            <h3 className="text-xl font-bold text-pi-dark mb-4">‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§™‡§§‡§æ</h3>
                            <form onSubmit={handleAddressSubmit}>
                                <textarea 
                                    required 
                                    placeholder="‡§™‡•Ç‡§∞‡§æ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§™‡§§‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç..." 
                                    value={deliveryAddress} 
                                    onChange={(e) => setDeliveryAddress(e.target.value)}
                                    className="p-3 w-full border border-gray-300 rounded-lg h-24 focus:ring-pi-blue focus:border-pi-blue shadow-sm"
                                ></textarea>
                                <button type="submit" className="mt-3 bg-pi-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition shadow-md">
                                    ‡§™‡§§‡§æ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Buyer: Review Option */}
                    {listing.isBuyer && orderStatus === 'Delivered' && !isReviewSubmitted && (
                        <div className="mb-8 p-5 border border-gray-200 rounded-xl bg-green-50">
                            <h3 className="text-xl font-bold text-pi-dark mb-4">‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ</h3>
                            <form onSubmit={handleReviewSubmit}>
                                <textarea 
                                    required 
                                    placeholder="‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ (Review) ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..." 
                                    value={review} 
                                    onChange={(e) => setReview(e.target.value)}
                                    className="p-3 w-full border border-gray-300 rounded-lg h-24 focus:ring-green-500 focus:border-green-500 shadow-sm"
                                ></textarea>
                                <div className="mt-3">
                                    <label className="mr-4 text-gray-700">‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó:</label>
                                    {[1, 2, 3, 4, 5].map(star => (
                                        <Star key={star} size={24} className="inline-block text-yellow-500 fill-yellow-500 cursor-pointer" />
                                    ))}
                                </div>
                                <button type="submit" className="mt-3 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-md">
                                    ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };
        
        // --- Component: Admin Page (No change) ---
        const AdminPage = ({ isAdmin }) => {
            if (!isAdmin) {
                return (
                    <div className="max-w-xl mx-auto p-8 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-xl mt-8 shadow-xl">
                        <h2 className="text-2xl font-bold mb-3">‚ùå ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§</h2>
                        <p>‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•ã ‡§¶‡•á‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è **‡§è‡§°‡§Æ‡§ø‡§® (Developer Wallet ID)** ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white rounded-xl shadow-2xl mt-8">
                    <h2 className="text-3xl font-bold text-red-600 mb-6 border-b pb-3 flex items-center"><Settings size={28} className="mr-2" /> Admin Dashboard</h2>
                    
                    <div className="space-y-6">
                        {/* Dev Wallet Info */}
                        <div className="p-5 border border-gray-200 rounded-xl bg-yellow-50">
                            <h3 className="text-xl font-bold text-pi-dark mb-2">‡§°‡•á‡§µ‡§≤‡§™‡§∞ ‡§µ‡•â‡§≤‡•á‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3>
                            <p className="font-mono break-all text-sm">ID: {ADMIN_ID}</p>
                            <p className="mt-2 text-green-600 font-semibold">‡§∏‡•ç‡§•‡§ø‡§§‡§ø: ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ (Verified)</p>
                            <p className="text-sm text-gray-700 mt-1">‡§Ø‡§π‡§æ‡§Ç ‡§∏‡•á ‡§Ü‡§™ Pi SDK ‡§∏‡•á ‡§Ö‡§™‡§®‡§æ ‡§°‡•á‡§µ‡§≤‡§™‡§∞ ‡§µ‡•â‡§≤‡•á‡§ü ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏ ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                        </div>

                        {/* Order Management Mock */}
                        <div className="p-5 border border-gray-200 rounded-xl">
                            <h3 className="text-xl font-bold text-pi-dark mb-4">‡§ë‡§∞‡•ç‡§°‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® (Seller/Admin View)</h3>
                            <p className="text-sm text-gray-700 mb-4">‡§è‡§°‡§Æ‡§ø‡§® ‡§∏‡§≠‡•Ä ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó Pi ‡§≠‡•Å‡§ó‡§§‡§æ‡§®‡•ã‡§Ç ‡§î‡§∞ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§ü‡•ç‡§∞‡•à‡§ï/‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§</p>
                            <button className="bg-pi-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition shadow-md">
                                ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§ë‡§∞‡•ç‡§°‡§∞‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç (Mock)
                            </button>
                        </div>

                        {/* Security & Audit Mock */}
                        <div className="p-5 border border-gray-200 rounded-xl bg-red-50">
                            <h3 className="text-xl font-bold text-red-600 mb-4 flex items-center"><Shield size={20} className="mr-2" /> ‡§π‡§æ‡§à ‡§≤‡•á‡§µ‡§≤ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§Å‡§ö</h3>
                            <p className="text-sm text-gray-700">‡§Ø‡§π‡§æ‡§Ç, ‡§π‡§Æ ‡§Ö‡§®‡§ß‡§ø‡§ï‡•É‡§§ API ‡§ï‡•â‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Firebase Functions (Mock) ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§≤‡•â‡§ó ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
                            <button className="mt-3 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition shadow-md">
                                ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§≤‡•â‡§ó ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Root App Component ---
        const App = () => {
            const { db, auth, storage, user, isAuthReady, isMockMode } = useFirebase();
            const { piPrice, loading: converterLoading } = useConverter();
            const { callGemini, generateImage } = useGemini();
            const [currentPage, setCurrentPage] = useState('deals');
            const [pageParams, setPageParams] = useState({});

            const navigate = (page, params = {}) => {
                setCurrentPage(page);
                setPageParams(params);
            };

            const isAdmin = user && user.uid === ADMIN_ID;

            const handleSignOut = () => {
                if (auth) {
                    auth.signOut().then(() => {
                        alert('Sign Out Successful.');
                        window.location.reload(); 
                    }).catch(error => {
                        console.error("Sign out error:", error);
                        alert(`Sign Out Error: ${error.message}`);
                    });
                } else {
                    alert('Mock Sign Out.');
                    window.location.reload(); 
                }
            };
            
            // Render the current page based on state
            const renderPage = () => {
                if (!isAuthReady) {
                    return (
                        <div className="text-center p-20">
                            <p className="text-xl font-semibold text-pi-dark">üõ°Ô∏è ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§Å‡§ö ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
                            <p className="text-gray-500 mt-2">Firebase, Pi Auth ‡§î‡§∞ Render Variables ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‡•§</p>
                        </div>
                    );
                }

                switch (currentPage) {
                    case 'deals':
                    case 'listings': 
                        return <DealsPage db={db} user={user} storage={storage} navigate={navigate} piPrice={piPrice} isMockMode={isMockMode} callGemini={callGemini} generateImage={generateImage} />;
                    case 'chat':
                        return <ChatPage db={db} user={user} isMockMode={isMockMode} />;
                    case 'ai':
                        return <AIHelperPage piPrice={piPrice} loading={converterLoading} callGemini={callGemini} />;
                    case 'admin':
                        return <AdminPage isAdmin={isAdmin} />;
                    case 'order':
                        return <OrderPage db={db} user={user} params={pageParams} />;
                    default:
                        return <DealsPage db={db} user={user} storage={storage} navigate={navigate} piPrice={piPrice} isMockMode={isMockMode} callGemini={callGemini} generateImage={generateImage} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <Header 
                        user={user} 
                        isAdmin={isAdmin} 
                        onSignOut={handleSignOut} 
                        navigate={navigate} 
                        currentPage={currentPage}
                    />
                    <main className="pb-20">
                        {renderPage()}
                    </main>
                    {/* Fixed Footer for UID Display */}
                    <div className="fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-2 text-center text-xs shadow-inner z-40">
                        <span className="font-bold">Current User ID: </span>
                        <span className="font-mono break-all">{user ? user.uid : 'Signing In...'}</span>
                        {isMockMode && <span className="text-yellow-400 font-bold ml-2">(MOCK MODE)</span>}
                    </div>
                </div>
            );
        };

        // --- Render the App ---
        if (typeof ReactDOM !== 'undefined' && typeof React !== 'undefined') {
            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        } else {
            document.getElementById('root').innerHTML = `
                <div class="p-8 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-xl m-8 shadow-xl">
                    <h2 class="text-2xl font-bold mb-3">‚ùå ‡§ó‡§Ç‡§≠‡•Ä‡§∞ CDN ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</h2>
                    <p>React ‡§Ø‡§æ Babel ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§à‡§Ç‡•§ Render ‡§Ø‡§æ ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                </div>
            `;
        }
    </script>
</body>
</html>
