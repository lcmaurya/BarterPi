<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barter-Pi Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --primary-color: #6a0dad; /* Darker Purple */
            --secondary-color: #8a2be2; /* Blue Violet */
            --accent-color: #be8ee4; /* Light Purple */
            --text-color: #e0e0e0;
            --background-dark: #1a1a2e;
            --background-light: #2e0f4d;
            --border-color: #5a008a;
            --button-hover: #5a0dad;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-dark);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-icon {
            height: 40px; /* Adjust size as needed */
            margin-right: 10px;
            border-radius: 5px; /* Optional: if you want rounded corners for the icon */
        }

        h1 {
            color: var(--text-color);
            margin: 0;
            font-size: 1.8em;
            letter-spacing: 1px;
        }

        nav button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 10px 18px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        nav button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        .container {
            flex-grow: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            background-color: var(--background-light);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h2 {
            color: var(--accent-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.6em;
        }

        /* Home Page Specifics */
        .gcv-section, .about-section {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .gcv-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .gcv-input-group label {
            margin-right: 10px;
            font-size: 1.1em;
            min-width: 80px;
        }

        .gcv-input-group input[type="number"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: #3a3a5a;
            color: var(--text-color);
            border-radius: 5px;
            font-size: 1em;
            max-width: 150px;
        }

        .gcv-results p {
            font-size: 1.1em;
            margin: 5px 0;
            color: var(--accent-color);
        }

        /* Profile Page Specifics */
        .profile-info, .user-actions {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .profile-info p {
            margin: 8px 0;
            font-size: 1.1em;
        }

        .profile-info strong {
            color: var(--accent-color);
        }

        /* Listing/Order Forms */
        form {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        form div {
            margin-bottom: 15px;
        }

        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--accent-color);
        }

        form input[type="text"],
        form input[type="number"],
        form textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: #3a3a5a;
            color: var(--text-color);
            border-radius: 5px;
            font-size: 1em;
        }

        form textarea {
            min-height: 80px;
            resize: vertical;
        }

        form button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        form button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        /* Listings/Orders Display */
        .listing-grid, .order-list, .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .listing-item, .order-item, .admin-item {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .listing-item:hover, .order-item:hover, .admin-item:hover {
            transform: translateY(-5px);
        }

        .listing-item h3, .order-item h3 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .listing-item p, .order-item p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .listing-item .price, .order-item .total {
            font-weight: bold;
            color: #aaffaa; /* Green for prices */
            font-size: 1.1em;
        }

        .listing-item button.buy-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .listing-item button.buy-button:hover {
            background-color: #45a049;
        }

        /* Chat/AI Helper */
        .chat-container {
            height: 400px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background-color: var(--secondary-color);
            align-self: flex-end;
            color: white;
        }

        .chat-message.ai {
            background-color: #555;
            align-self: flex-start;
            color: white;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input-group input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: #3a3a5a;
            color: var(--text-color);
            border-radius: 5px;
            font-size: 1em;
        }
        .chat-input-group button {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .chat-input-group button:hover {
            background-color: var(--button-hover);
        }

        footer {
            background-color: var(--primary-color);
            color: var(--text-color);
            text-align: center;
            padding: 15px 20px;
            margin-top: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            font-size: 0.9em;
        }

        /* Admin Page Specifics */
        .admin-item button {
            background-color: #d9534f; /* Red for delete/reject */
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }
        .admin-item button.approve {
            background-color: #5cb85c; /* Green for approve */
        }
        .admin-item button:hover {
            opacity: 0.8;
        }

        /* Pi SDK Status */
        #pi-sdk-status {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            font-size: 0.9em;
            color: var(--accent-color);
        }
        #pi-sdk-status.ready {
            color: #aaffaa; /* Green for ready */
        }
        #pi-sdk-status.error {
            color: #ffaaaa; /* Red for error */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 10px;
            }
            nav {
                margin-top: 10px;
            }
            nav button {
                margin: 5px;
                width: calc(50% - 10px); /* Two buttons per row */
            }
            .listing-grid, .order-list, .admin-controls {
                grid-template-columns: 1fr;
            }
            .container {
                margin: 10px auto;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="barter_pi_logo.png" alt="Barter Pi Logo" class="logo-icon">
            <h1>Barter-Pi Pro</h1>
        </div>
        <nav>
            <button data-page="home">Home</button>
            <button data-page="profile">Profile</button>
            <button data-page="orders">Orders</button>
            <button data-page="chat">Chat</button>
            <button data-page="ai-helper">AI Helper</button>
            <button data-page="admin">Admin</button>
        </nav>
    </header>

    <main class="container">
        <section id="home-page" class="page active">
            <h2>Welcome to Barter-Pi Pro!</h2>
            <div class="gcv-section">
                <h3>Pi GCV Converter (Realtime)</h3>
                <div class="gcv-input-group">
                    <label for="pi-amount">Pi Amount:</label>
                    <input type="number" id="pi-amount" value="1" min="0.01" step="0.01">
                </div>
                <div class="gcv-results">
                    <p><strong>GCV Rate:</strong> $314,159.00 USD</p>
                    <p><strong>Converted USD:</strong> <span id="converted-usd"></span></p>
                    <p><strong>Converted INR:</strong> <span id="converted-inr"></span></p>
                </div>
            </div>
            <div class="about-section">
                <h3>About Barter-Pi Pro</h3>
                <p>Barter-Pi Pro is a decentralized marketplace empowering the Pi Network community to trade goods and services using Pi currency. We adhere to the Global Consensus Value (GCV) to ensure fair and transparent transactions.</p>
                <p>Our platform aims to provide a secure and user-friendly experience, connecting Pioneers worldwide. Explore listings, create your own, and participate in the evolving Pi economy.</p>
                <p><strong>Current Pi SDK Status:</strong> <span id="pi-sdk-status">Loading...</span></p>
                <button id="test-pi-transaction">Test Pi Transaction</button>
            </div>
        </section>

        <section id="profile-page" class="page">
            <h2>Your Profile</h2>
            <div class="profile-info">
                <h3>Account Details</h3>
                <p><strong>Pioneer ID:</strong> <span id="pioneer-id">Loading...</span></p>
                <p><strong>Wallet Address:</strong> <span id="wallet-address">Not Connected</span></p>
                <p><strong>Join Date:</strong> <span id="join-date">N/A</span></p>
            </div>
            <div class="user-actions">
                <h3>Your Listings</h3>
                <div class="listing-grid" id="user-listings">
                    <p>No listings yet. Create one below!</p>
                </div>
                <h3>Create New Listing</h3>
                <form id="new-listing-form">
                    <div>
                        <label for="listing-title">Title:</label>
                        <input type="text" id="listing-title" required>
                    </div>
                    <div>
                        <label for="listing-description">Description:</label>
                        <textarea id="listing-description" required></textarea>
                    </div>
                    <div>
                        <label for="listing-price">Price (in Pi):</label>
                        <input type="number" id="listing-price" min="0.01" step="0.01" required>
                    </div>
                    <div>
                        <label for="listing-image">Image URL (Optional):</label>
                        <input type="text" id="listing-image">
                    </div>
                    <button type="submit">Publish Listing</button>
                </form>
            </div>
        </section>

        <section id="orders-page" class="page">
            <h2>Your Orders</h2>
            <h3>Purchased Items</h3>
            <div class="order-list" id="purchased-orders">
                <p>No purchased orders yet.</p>
            </div>
            <h3>Received Orders (For your listings)</h3>
            <div class="order-list" id="received-orders">
                <p>No received orders yet.</p>
            </div>
        </section>

        <section id="chat-page" class="page">
            <h2>Community Chat</h2>
            <div class="chat-container" id="community-chat-messages">
                <div class="chat-message ai">Welcome to the Barter-Pi community chat!</div>
            </div>
            <div class="chat-input-group">
                <input type="text" id="chat-input" placeholder="Type your message...">
                <button id="send-chat-message">Send</button>
            </div>
        </section>

        <section id="ai-helper-page" class="page">
            <h2>AI Assistant (Gemini)</h2>
            <div class="chat-container" id="ai-chat-messages">
                <div class="chat-message ai">Hello! How can I assist you with your Barter-Pi experience today?</div>
            </div>
            <div class="chat-input-group">
                <input type="text" id="ai-chat-input" placeholder="Ask the AI for help...">
                <button id="send-ai-chat-message">Ask AI</button>
            </div>
        </section>

        <section id="admin-page" class="page">
            <h2>Admin Dashboard</h2>
            <h3>Pending Listings for Approval</h3>
            <div class="admin-controls" id="pending-listings">
                <p>No pending listings.</p>
            </div>
            <h3>User Management</h3>
            <div class="admin-controls" id="user-management">
                <p>User management features coming soon.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 Barter-Pi Pro. All rights reserved. Built for the Pi Network community.</p>
    </footer>

    <script>
        // Your Firebase configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Core Logic ---

        // GCV Converter
        const GCV_RATE_USD = 314159.00; // Global Consensus Value for Pi in USD
        const USD_TO_INR_RATE = 83.3; // Approximate current USD to INR rate

        function updateGcvConversion() {
            const piAmountInput = document.getElementById('pi-amount');
            const convertedUsdSpan = document.getElementById('converted-usd');
            const convertedInrSpan = document.getElementById('converted-inr');

            let piAmount = parseFloat(piAmountInput.value);
            if (isNaN(piAmount) || piAmount <= 0) {
                piAmount = 0;
            }

            const usdValue = piAmount * GCV_RATE_USD;
            const inrValue = usdValue * USD_TO_INR_RATE;

            convertedUsdSpan.textContent = `$${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD`;
            convertedInrSpan.textContent = `₹${inrValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} INR`;
        }

        // Event listener for GCV input
        document.getElementById('pi-amount').addEventListener('input', updateGcvConversion);
        updateGcvConversion(); // Initial calculation

        // Navigation
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(`${pageId}-page`).classList.add('active');
            console.log(`Switched to ${pageId} page.`);

            // Call specific rendering functions when a page is activated
            if (pageId === 'home') {
                updateGcvConversion(); // Ensure GCV is updated
                checkPiReady(); // Check Pi SDK status
            } else if (pageId === 'profile') {
                renderListings(); // Render user's listings
            } else if (pageId === 'orders') {
                renderOrders(); // Render user's orders
            } else if (pageId === 'admin') {
                renderAdmin(); // Render admin specific content
            }
        }

        function setupNavigation() {
            document.querySelectorAll('nav button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const page = event.target.dataset.page;
                    switchPage(page);
                });
            });
        }
        setupNavigation();
        switchPage('home'); // Default to home page

        // --- Firebase Firestore Interactions ---

        // Render Listings (for Profile page and Home page - though Home page uses a grid of ALL listings)
        async function renderListings() {
            const userListingsContainer = document.getElementById('user-listings');
            userListingsContainer.innerHTML = ''; // Clear previous listings

            try {
                // For demonstration, let's assume a logged-in user with a uid
                // In a real app, you'd get the current user's uid from Firebase Auth
                const dummyUserId = "testUser123"; // Replace with actual Firebase Auth user ID

                const querySnapshot = await db.collection('listings')
                                              .where('userId', '==', dummyUserId) // Filter by current user
                                              .get();

                if (querySnapshot.empty) {
                    userListingsContainer.innerHTML = '<p>No listings yet. Create one below!</p>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const listing = doc.data();
                    const listingElement = document.createElement('div');
                    listingElement.classList.add('listing-item');
                    listingElement.innerHTML = `
                        <h3>${listing.title}</h3>
                        <p>${listing.description}</p>
                        ${listing.imageUrl ? `<img src="${listing.imageUrl}" alt="${listing.title}" style="width:100%; height:auto; border-radius:5px; margin-bottom:10px;">` : ''}
                        <p class="price">Price: ${listing.price} Pi</p>
                        <p>Status: ${listing.status || 'Active'}</p>
                        <button class="edit-listing">Edit</button>
                        <button class="delete-listing">Delete</button>
                    `;
                    userListingsContainer.appendChild(listingElement);
                });
            } catch (error) {
                console.error("Error fetching user listings:", error);
                userListingsContainer.innerHTML = '<p>Error loading listings. Please try again.</p>';
            }
        }

        // Render Orders (for Orders page)
        async function renderOrders() {
            const purchasedOrdersContainer = document.getElementById('purchased-orders');
            const receivedOrdersContainer = document.getElementById('received-orders');
            purchasedOrdersContainer.innerHTML = '<p>Loading purchased orders...</p>';
            receivedOrdersContainer.innerHTML = '<p>Loading received orders...</p>';

            try {
                const dummyUserId = "testUser123"; // Replace with actual Firebase Auth user ID

                // Purchased Orders
                const purchasedSnapshot = await db.collection('orders')
                                                   .where('buyerId', '==', dummyUserId)
                                                   .get();
                if (purchasedSnapshot.empty) {
                    purchasedOrdersContainer.innerHTML = '<p>No purchased orders yet.</p>';
                } else {
                    purchasedOrdersContainer.innerHTML = '';
                    purchasedSnapshot.forEach(doc => {
                        const order = doc.data();
                        const orderElement = document.createElement('div');
                        orderElement.classList.add('order-item');
                        orderElement.innerHTML = `
                            <h3>Order for: ${order.listingTitle}</h3>
                            <p>Quantity: ${order.quantity}</p>
                            <p class="total">Total Pi: ${order.totalPi}</p>
                            <p>Status: ${order.status}</p>
                            <p>Seller: ${order.sellerId}</p>
                        `;
                        purchasedOrdersContainer.appendChild(orderElement);
                    });
                }

                // Received Orders (orders placed on user's listings)
                const receivedSnapshot = await db.collection('orders')
                                                 .where('sellerId', '==', dummyUserId)
                                                 .get();
                if (receivedSnapshot.empty) {
                    receivedOrdersContainer.innerHTML = '<p>No received orders yet.</p>';
                } else {
                    receivedOrdersContainer.innerHTML = '';
                    receivedSnapshot.forEach(doc => {
                        const order = doc.data();
                        const orderElement = document.createElement('div');
                        orderElement.classList.add('order-item');
                        orderElement.innerHTML = `
                            <h3>Order from: ${order.buyerId}</h3>
                            <p>For: ${order.listingTitle}</p>
                            <p>Quantity: ${order.quantity}</p>
                            <p class="total">Total Pi: ${order.totalPi}</p>
                            <p>Status: ${order.status}</p>
                        `;
                        receivedOrdersContainer.appendChild(orderElement);
                    });
                }

            } catch (error) {
                console.error("Error fetching orders:", error);
                purchasedOrdersContainer.innerHTML = '<p>Error loading purchased orders.</p>';
                receivedOrdersContainer.innerHTML = '<p>Error loading received orders.</p>';
            }
        }

        // Handle New Listing Submission
        document.getElementById('new-listing-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const title = document.getElementById('listing-title').value;
            const description = document.getElementById('listing-description').value;
            const price = parseFloat(document.getElementById('listing-price').value);
            const imageUrl = document.getElementById('listing-image').value;

            if (!title || !description || isNaN(price) || price <= 0) {
                alert('Please fill in all required fields and ensure the price is valid.');
                return;
            }

            try {
                // In a real app, get current user UID from Firebase Auth
                const dummyUserId = "testUser123";
                const dummyUserName = "Test Pioneer"; // Or fetch from user profile

                await db.collection('listings').add({
                    title: title,
                    description: description,
                    price: price,
                    imageUrl: imageUrl,
                    userId: dummyUserId,
                    userName: dummyUserName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending' // Listings might need admin approval
                });

                alert('Listing submitted successfully! It will be reviewed by an admin.');
                document.getElementById('new-listing-form').reset();
                renderListings(); // Re-render user's listings
            } catch (error) {
                console.error("Error adding listing:", error);
                alert('Failed to publish listing. Please try again.');
            }
        });

        // Render Admin Controls (for Admin page)
        async function renderAdmin() {
            const pendingListingsContainer = document.getElementById('pending-listings');
            pendingListingsContainer.innerHTML = '<p>Loading pending listings...</p>';

            try {
                // Fetch listings with status 'pending'
                const querySnapshot = await db.collection('listings')
                                              .where('status', '==', 'pending')
                                              .get();

                if (querySnapshot.empty) {
                    pendingListingsContainer.innerHTML = '<p>No pending listings for approval.</p>';
                    return;
                }

                pendingListingsContainer.innerHTML = ''; // Clear previous
                querySnapshot.forEach(doc => {
                    const listing = doc.data();
                    const listingElement = document.createElement('div');
                    listingElement.classList.add('admin-item');
                    listingElement.innerHTML = `
                        <h3>${listing.title}</h3>
                        <p>By: ${listing.userName || 'Unknown'}</p>
                        <p>${listing.description.substring(0, 100)}...</p>
                        <p>Price: ${listing.price} Pi</p>
                        <button class="approve" data-id="${doc.id}">Approve</button>
                        <button class="reject" data-id="${doc.id}">Reject</button>
                    `;
                    pendingListingsContainer.appendChild(listingElement);
                });

                // Add event listeners for admin actions
                pendingListingsContainer.querySelectorAll('.approve').forEach(button => {
                    button.addEventListener('click', (e) => handleListingAction(e.target.dataset.id, 'approved'));
                });
                pendingListingsContainer.querySelectorAll('.reject').forEach(button => {
                    button.addEventListener('click', (e) => handleListingAction(e.target.dataset.id, 'rejected'));
                });

            } catch (error) {
                console.error("Error fetching pending listings for admin:", error);
                pendingListingsContainer.innerHTML = '<p>Error loading pending listings.</p>';
            }
        }

        async function handleListingAction(listingId, action) {
            if (!confirm(`Are you sure you want to ${action} this listing?`)) {
                return;
            }
            try {
                await db.collection('listings').doc(listingId).update({ status: action });
                alert(`Listing ${action} successfully!`);
                renderAdmin(); // Re-render admin page
            } catch (error) {
                console.error(`Error ${action} listing ${listingId}:`, error);
                alert(`Failed to ${action} listing. Please try again.`);
            }
        }


        // --- Chat Logic ---
        function appendChatMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', type);
            messageElement.textContent = message;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight; // Auto-scroll to bottom
        }

        document.getElementById('send-chat-message').addEventListener('click', () => {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                appendChatMessage('community-chat-messages', message, 'user');
                // In a real app, send message to Firebase Firestore 'chats' collection
                input.value = '';
                // Example of a dummy response for community chat
                setTimeout(() => {
                    appendChatMessage('community-chat-messages', "Thanks for your message!", 'ai');
                }, 1000);
            }
        });

        document.getElementById('send-ai-chat-message').addEventListener('click', async () => {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (message) {
                appendChatMessage('ai-chat-messages', message, 'user');
                input.value = 'Thinking...'; // Indicate AI is processing
                input.disabled = true;

                // Simulate AI response (replace with actual Gemini API call)
                try {
                    // This part would involve a server-side call to Gemini API
                    // For client-side simulation:
                    const aiResponse = await simulateGeminiResponse(message);
                    appendChatMessage('ai-chat-messages', aiResponse, 'ai');
                } catch (error) {
                    console.error("Error with AI response:", error);
                    appendChatMessage('ai-chat-messages', "Sorry, I'm having trouble connecting to the AI right now.", 'ai');
                } finally {
                    input.value = '';
                    input.disabled = false;
                }
            }
        });

        async function simulateGeminiResponse(query) {
            // This is a placeholder for your actual server-side Gemini integration.
            // In a real application, you would make an HTTP request to your backend,
            // which then calls the Gemini API to keep your API key secure.
            console.log("Simulating AI response for:", query);
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate delay

            if (query.toLowerCase().includes("gcv")) {
                return "The Pi Global Consensus Value (GCV) is currently set at $314,159 USD per Pi, as agreed upon by a significant portion of the Pi Network community for real-world transactions.";
            } else if (query.toLowerCase().includes("barter")) {
                return "Barter-Pi Pro is a platform designed to facilitate the exchange of goods and services using Pi currency, following the GCV. You can list items, buy from others, and manage your orders here.";
            } else if (query.toLowerCase().includes("listing")) {
                return "To create a new listing, go to the Profile page and fill out the 'Create New Listing' form. Your listing will be reviewed before it goes live.";
            } else if (query.toLowerCase().includes("hello")) {
                return "Hello Pioneer! How can I assist you with Barter-Pi Pro today?";
            }
            return "I'm an AI assistant for Barter-Pi Pro. You can ask me about listings, orders, the Pi GCV, or how to use the platform. What's on your mind?";
        }


        // --- Pi SDK Integration (Dummy/Placeholder) ---
        let piSdkReady = false;
        const piSdkStatusElement = document.getElementById('pi-sdk-status');

        function loadPiSdkScript() {
            return new Promise((resolve, reject) => {
                // Check if Pi SDK is already loaded
                if (window.Pi) {
                    console.log("Pi SDK already available.");
                    piSdkReady = true;
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = "https://sdk.mine.pi/pi-sdk.js";
                script.async = true;
                script.onload = () => {
                    console.log("Pi SDK script loaded successfully.");
                    // Check if Pi SDK is actually initialized
                    if (window.Pi) {
                        piSdkReady = true;
                        resolve();
                    } else {
                        console.error("Pi SDK script loaded, but Pi object not found.");
                        reject("Pi object not found after script load.");
                    }
                };
                script.onerror = () => {
                    console.error("Failed to load Pi SDK script.");
                    reject("Failed to load Pi SDK script.");
                };
                document.head.appendChild(script);
            });
        }

        async function checkPiReady() {
            try {
                await loadPiSdkScript();
                if (piSdkReady) {
                    piSdkStatusElement.textContent = "Ready";
                    piSdkStatusElement.classList.remove('error');
                    piSdkStatusElement.classList.add('ready');
                    // Initialize Pi SDK (replace with your actual config)
                    // You need to register your app on the Pi Developer Portal to get a proper config
                    if (window.Pi && !window.Pi._isInitialized) {
                        try {
                            const piAppConfig = {
                                app_name: "Barter-Pi Pro",
                                version: "1.0",
                                client_id: "YOUR_PI_APP_CLIENT_ID" // <-- IMPORTANT: Replace with your actual Pi App Client ID
                            };
                            window.Pi.init(piAppConfig);
                            console.log("Pi SDK initialized.");
                            // If you need user data immediately:
                            // await window.Pi.authenticate().then(auth => {
                            //     document.getElementById('pioneer-id').textContent = auth.user.uid;
                            //     console.log("Pi user authenticated:", auth.user);
                            // });
                        } catch (initError) {
                            console.error("Error initializing Pi SDK:", initError);
                            piSdkStatusElement.textContent = `Error: ${initError.message || 'Initialization failed'}`;
                            piSdkStatusElement.classList.remove('ready');
                            piSdkStatusElement.classList.add('error');
                        }
                    }
                }
            } catch (error) {
                piSdkStatusElement.textContent = `Error: ${error.message || 'SDK failed to load'}`;
                piSdkStatusElement.classList.remove('ready');
                piSdkStatusElement.classList.add('error');
            }
        }

        document.getElementById('test-pi-transaction').addEventListener('click', async () => {
            if (!piSdkReady || !window.Pi || !window.Pi._isInitialized) {
                alert("Pi SDK is not ready or initialized. Please wait or refresh.");
                return;
            }

            try {
                // Request user authentication (if not already authenticated)
                const authResult = await window.Pi.authenticate();
                const userUid = authResult.user.uid;
                document.getElementById('pioneer-id').textContent = userUid;
                console.log("Authenticated Pi user:", userUid);

                const payment = await window.Pi.createPayment({
                    amount: 0.01, // Smallest possible amount for a test
                    memo: "Test transaction for Barter-Pi Pro", // Required
                    metadata: {
                        productId: "test-product-001",
                        description: "Just a test"
                    }
                });

                alert(`Test Pi transaction initiated!\nPayment ID: ${payment.identifier}\nStatus: ${payment.status}`);
                console.log("Test Payment initiated:", payment);

                // Optionally, await for the payment to be completed
                const completedPayment = await payment.complete();
                alert(`Test Pi transaction completed!\nStatus: ${completedPayment.status}`);
                console.log("Test Payment completed:", completedPayment);

            } catch (error) {
                console.error("Error during Pi transaction:", error);
                alert(`Pi transaction failed: ${error.message}`);
            }
        });

        // Initial check for Pi SDK status
        checkPiReady();

        // Placeholder for user profile data (will be fetched from Firebase Auth/Firestore in real app)
        function loadUserProfile() {
            // In a real app, you'd listen for Firebase auth state changes
            // auth.onAuthStateChanged(user => { ... });
            document.getElementById('pioneer-id').textContent = "PioneerXYZ123"; // Dummy data
            document.getElementById('wallet-address').textContent = "GA...XYZ"; // Dummy data
            document.getElementById('join-date').textContent = "2023-01-15"; // Dummy data
        }
        loadUserProfile(); // Load dummy profile on startup

    </script>
</body>
</html>